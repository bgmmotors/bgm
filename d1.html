<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Performance CLM6 â€“ Andon</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; font-family: Arial, Helvetica, sans-serif; color:#fff; }
    .wrapper { display:flex; flex-direction:column; height:100vh; padding:16px 24px; box-sizing:border-box; background:#000; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .header-title { font-size:36px; font-weight:bold; }
    .header-right { text-align:right; }
    .header-date { font-size:28px; font-weight:bold; }
    .header-coverage { font-size:18px; color:#aaa; }

    .kpi-row { display:grid; grid-template-columns: 2fr repeat(4, 1fr); gap:12px; margin-bottom:16px; }
    .kpi-card { background:#111; border-radius:14px; padding:12px 16px; box-shadow:0 0 10px rgba(0,0,0,0.6); display:flex; flex-direction:column; justify-content:space-between; border:3px solid #444; }
    .kpi-title { font-size:18px; margin-bottom:6px; }
    .kpi-main { font-size:26px; font-weight:bold; }
    .kpi-sub { font-size:14px; color:#ccc; }
    .status-pill { display:inline-block; padding:4px 10px; border-radius:999px; font-weight:bold; font-size:14px; margin-bottom:4px; }

    .pill-ok { background:#00b050; color:#000; }
    .pill-mid { background:#9acd32; color:#000; } /* amarelo-esverdeado */
    .pill-nok { background:#c00000; color:#fff; }
    .pill-idle { background:#444; color:#fff; }

    .table-container { flex:1; overflow-y:auto; border-radius:10px; background:#111; padding:10px; }
    table { width:100%; border-collapse:collapse; background:#111; color:#fff; font-size:14px; }
    thead th { position:sticky; top:0; background:#222; padding:8px; border-bottom:2px solid #555; border-right:1px solid #555; }
    tbody td { padding:6px 4px; text-align:center; border-bottom:1px solid #222; border-right:1px solid #222; }

    .row-current { background:#262626; }

    /* Performance cores */
    .cell-ok { background:#00b050; color:#000; font-weight:bold; }
    .cell-mid { background:#9acd32; color:#000; font-weight:bold; }
    .cell-nok { background:#c00000; color:#fff; font-weight:bold; }

    /* STOP / status cores fixas */
    .cell-mnt { background: orange; color:#000; font-weight:bold; }
    .cell-mat { background: #808080; color:#000; font-weight:bold; }
    .cell-peo { background: #ff69b4; color:#000; font-weight:bold; }
    .cell-qual { background: #ffd400; color:#000; font-weight:bold; }
    .cell-nosched { background: #0070c0; color:#fff; font-weight:bold; }

    .shift-sum { background:#003366 !important; font-weight:bold; }
    .shift-sum td { border-top:2px solid #fff; }

    .footer-status { margin-top:6px; font-size:14px; color:#ccc; }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="header">
      <div class="header-title">Performance CLM6 â€“ Andon</div>
      <div class="header-right">
        <div class="header-date" id="currentDate">--</div>
        <div class="header-coverage" id="coverageText">No production yet</div>
      </div>
    </div>

    <div class="kpi-row">
      <div class="kpi-card" id="cardTotal">
        <div class="kpi-title">Total Production vs Target</div>
        <div class="kpi-main" id="totalProd">-</div>
        <div class="kpi-sub" id="totalTarget">Target: -</div>
        <div class="footer-status" id="overallStatus">Status: -</div>
      </div>

      <div class="kpi-card" id="cardLine1">
        <div class="kpi-title">Line 1</div>
        <div id="pillLine1" class="status-pill pill-idle">IDLE</div>
        <div class="kpi-sub">Last period: <span id="lastL1">-</span></div>
        <div class="kpi-sub">Accumulated: <span id="accL1">-</span></div>
      </div>

      <div class="kpi-card" id="cardLine2">
        <div class="kpi-title">Line 2</div>
        <div id="pillLine2" class="status-pill pill-idle">IDLE</div>
        <div class="kpi-sub">Last period: <span id="lastL2">-</span></div>
        <div class="kpi-sub">Accumulated: <span id="accL2">-</span></div>
      </div>

      <div class="kpi-card" id="cardLine3">
        <div class="kpi-title">Line 3</div>
        <div id="pillLine3" class="status-pill pill-idle">IDLE</div>
        <div class="kpi-sub">Last period: <span id="lastL3">-</span></div>
        <div class="kpi-sub">Accumulated: <span id="accL3">-</span></div>
      </div>

      <div class="kpi-card" id="cardLine4">
        <div class="kpi-title">Line 4</div>
        <div id="pillLine4" class="status-pill pill-idle">IDLE</div>
        <div class="kpi-sub">Last period: <span id="lastL4">-</span></div>
        <div class="kpi-sub">Accumulated: <span id="accL4">-</span></div>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Shift</th>
            <th>Time</th>
            <th>Target</th>
            <th>Line 1</th>
            <th>Line 2</th>
            <th>Line 3</th>
            <th>Line 4</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div class="footer-status" id="lastUpdate">Last update: --</div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxugNG9AE1dpoobCrOYFaTzbH3EUVkd1SbbASSdcaG3eZBLuoePB5F0bolIgiCiqqIT/exec";

    function getTodayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function formatDateHeader() {
      const now = new Date();
      const d = String(now.getDate()).padStart(2, "0");
      const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const m = monthNames[now.getMonth()];
      const y = String(now.getFullYear()).slice(-2);
      document.getElementById("currentDate").textContent = `${d}-${m}-${y}`;
    }

    function setCoverage(ultimoSlot) {
      const el = document.getElementById("coverageText");
      if (!ultimoSlot) { el.textContent = "No production yet (T1 not started)"; return; }
      if (ultimoSlot.shift === 1) el.textContent = "Shift coverage: T1";
      else if (ultimoSlot.shift === 2) el.textContent = "Shift coverage: T1 + T2";
      else el.textContent = "Shift coverage: T1 + T2 + T3";
    }

    function setCardBorder(id, status) {
      const card = document.getElementById(id);
      if (!card) return;
      if (status === "OK") card.style.borderColor = "#00b050";
      else if (status === "MID") card.style.borderColor = "#9acd32";
      else if (status === "NOK") card.style.borderColor = "#c00000";
      else card.style.borderColor = "#666";
    }

    function perfClass(pct) {
      if (pct >= 1) return { cls: "cell-ok", face:"ðŸ™‚" };
      if (pct >= 0.95) return { cls: "cell-mid", face:"ðŸ˜" };
      return { cls: "cell-nok", face:"ðŸ™" };
    }

    function statusClass(kind) {
      if (kind === "STOP_MAINT") return "cell-mnt";
      if (kind === "STOP_MAT") return "cell-mat";
      if (kind === "STOP_PEO") return "cell-peo";
      if (kind === "STOP_QUAL") return "cell-qual";
      if (kind === "NO_SCHEDULE") return "cell-nosched";
      return "";
    }

    function calcUpToUltimo(slots, ultimo) {
      if (!ultimo) return slots;
      const out = [];
      for (const s of slots) {
        out.push(s);
        if (s.id_slot === ultimo.id_slot) break;
      }
      return out;
    }

    function updateTopKPIs(json) {
      const slots = json.slots || [];
      const ultimo = json.ultimo_slot || null;

      const considered = calcUpToUltimo(slots, ultimo);

      // target acumulado por linha = soma target_effective (por perÃ­odo)
      const targetPerLine = considered.reduce((acc, s) => acc + (Number(s.target_effective || 0)), 0);

      const acc = {
        line1: considered.reduce((a,s)=>a + Number(s.line1||0),0),
        line2: considered.reduce((a,s)=>a + Number(s.line2||0),0),
        line3: considered.reduce((a,s)=>a + Number(s.line3||0),0),
        line4: considered.reduce((a,s)=>a + Number(s.line4||0),0)
      };

      const totalProd = acc.line1 + acc.line2 + acc.line3 + acc.line4;
      const totalTarget = targetPerLine * 4;

      // total
      document.getElementById("totalProd").textContent = totalTarget > 0 ? totalProd : "-";
      document.getElementById("totalTarget").textContent = "Target: " + (totalTarget > 0 ? totalTarget : "-");

      let totalStatus = "IDLE";
      const overallStatus = document.getElementById("overallStatus");
      if (!ultimo || totalTarget <= 0) {
        overallStatus.textContent = "Status: Waiting for first launch";
        totalStatus = "IDLE";
      } else {
        const pct = totalProd / totalTarget;
        const p = perfClass(pct);
        totalStatus = (pct >= 1) ? "OK" : (pct >= 0.95) ? "MID" : "NOK";
        overallStatus.textContent = `Status: ${totalStatus} ${p.face}`;
      }
      setCardBorder("cardTotal", totalStatus);

      // last period = Ãºltimo slot
      const lastSlot = ultimo ? slots.find(s => s.id_slot === ultimo.id_slot) : null;

      const lineMeta = [
        { key:"line1", pill:"pillLine1", last:"lastL1", acc:"accL1", card:"cardLine1" },
        { key:"line2", pill:"pillLine2", last:"lastL2", acc:"accL2", card:"cardLine2" },
        { key:"line3", pill:"pillLine3", last:"lastL3", acc:"accL3", card:"cardLine3" },
        { key:"line4", pill:"pillLine4", last:"lastL4", acc:"accL4", card:"cardLine4" }
      ];

      lineMeta.forEach(m => {
        const pill = document.getElementById(m.pill);
        const lastSpan = document.getElementById(m.last);
        const accSpan = document.getElementById(m.acc);

        if (!ultimo || targetPerLine <= 0) {
          pill.textContent = "IDLE";
          pill.className = "status-pill pill-idle";
          lastSpan.textContent = "-";
          accSpan.textContent = "-";
          setCardBorder(m.card, "IDLE");
          return;
        }

        // last period
        const lastVal = lastSlot ? Number(lastSlot[m.key] || 0) : 0;
        const lastTarget = lastSlot ? Number(lastSlot.target_effective || lastSlot.target || 0) : 0;
        lastSpan.textContent = `${lastVal} / ${lastTarget}`;

        // accumulated
        const accVal = acc[m.key];
        accSpan.textContent = `${accVal} / ${targetPerLine}`;

        const pct = targetPerLine > 0 ? (accVal / targetPerLine) : 0;
        const p = perfClass(pct);
        if (pct >= 1) {
          pill.textContent = "OK " + p.face;
          pill.className = "status-pill pill-ok";
          setCardBorder(m.card, "OK");
        } else if (pct >= 0.95) {
          pill.textContent = "MID " + p.face;
          pill.className = "status-pill pill-mid";
          setCardBorder(m.card, "MID");
        } else {
          pill.textContent = "NOK " + p.face;
          pill.className = "status-pill pill-nok";
          setCardBorder(m.card, "NOK");
        }
      });
    }

    function buildTable(json) {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      const slots = json.slots || [];
      const ultimo = json.ultimo_slot || null;

      // agrupa por shift mantendo ordem
      const shifts = [1,2,3].map(s => ({ shift:s, slots: slots.filter(x => Number(x.shift) === s) }));

      shifts.forEach(group => {
        // linhas normais
        group.slots.forEach(slot => {
          const tr = document.createElement("tr");
          if (ultimo && slot.id_slot === ultimo.id_slot) tr.classList.add("row-current");

          const cShift = document.createElement("td");
          cShift.textContent = "Shift " + slot.shift;
          tr.appendChild(cShift);

          const cTime = document.createElement("td");
          cTime.textContent = slot.label;
          tr.appendChild(cTime);

          const cTarget = document.createElement("td");
          cTarget.textContent = Number(slot.target_effective || 0) > 0 ? slot.target_effective : "";
          tr.appendChild(cTarget);

          const lineDefs = [
            { key:"line1", disp:"disp1", st:"st1" },
            { key:"line2", disp:"disp2", st:"st2" },
            { key:"line3", disp:"disp3", st:"st3" },
            { key:"line4", disp:"disp4", st:"st4" }
          ];

          lineDefs.forEach(ld => {
            const td = document.createElement("td");
            const st = slot[ld.st] || "RUN";
            const targetEff = Number(slot.target_effective || 0);

            if (st !== "RUN") {
              td.textContent = slot[ld.disp] || "";
              td.classList.add(statusClass(st));
            } else {
              const v = Number(slot[ld.key] || 0);
              td.textContent = (v > 0 || targetEff > 0) ? String(v) : "";
              if (targetEff > 0) {
                const pct = v / targetEff;
                const p = perfClass(pct);
                td.classList.add(p.cls);
                td.textContent = `${v} ${p.face}`;
              }
            }
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        // linha acumulada do turno
        if (group.slots.length > 0) {
          const sum = {
            target: group.slots.reduce((a,s)=>a + Number(s.target_effective||0),0),
            line1: group.slots.reduce((a,s)=>a + Number(s.line1||0),0),
            line2: group.slots.reduce((a,s)=>a + Number(s.line2||0),0),
            line3: group.slots.reduce((a,s)=>a + Number(s.line3||0),0),
            line4: group.slots.reduce((a,s)=>a + Number(s.line4||0),0)
          };

          const trSum = document.createElement("tr");
          trSum.classList.add("shift-sum");

          const td1 = document.createElement("td");
          td1.colSpan = 2;
          td1.textContent = `CUMULATIVE RESULT â€“ SHIFT ${group.shift}`;
          trSum.appendChild(td1);

          const tdT = document.createElement("td");
          tdT.textContent = sum.target > 0 ? sum.target : "";
          trSum.appendChild(tdT);

          ["line1","line2","line3","line4"].forEach(k => {
            const td = document.createElement("td");
            const v = sum[k];
            if (sum.target > 0) {
              const pct = v / sum.target;
              const p = perfClass(pct);
              td.classList.add(p.cls);
              td.textContent = `${v} ${p.face}`;
            } else {
              td.textContent = v ? v : "";
            }
            trSum.appendChild(td);
          });

          tbody.appendChild(trSum);
        }
      });
    }

    async function refreshDashboard() {
      try {
        const today = getTodayISO();
        const res = await fetch(`${SCRIPT_URL}?action=dailyProduction&data=${today}`);
        const json = await res.json();

        if (json.status !== "success") {
          console.error("API error:", json.message);
          document.getElementById("coverageText").textContent = "Error loading data";
          return;
        }

        setCoverage(json.ultimo_slot || null);
        updateTopKPIs(json);
        buildTable(json);

        document.getElementById("lastUpdate").textContent = "Last update: " + new Date().toLocaleTimeString();
      } catch (err) {
        console.error(err);
        document.getElementById("coverageText").textContent = "Error calling API";
      }
    }

    formatDateHeader();
    refreshDashboard();
    setInterval(refreshDashboard, 30000); // pode ajustar (ex: 10s) se quiser
  </script>
</body>
</html>
