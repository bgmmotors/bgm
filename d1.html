<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Performance CLM6 – Andon</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #000;
      font-family: Arial, Helvetica, sans-serif;
      color: #fff;
    }

    .wrapper {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 16px 24px;
      box-sizing: border-box;
      background: #000;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .header-title {
      font-size: 36px;
      font-weight: bold;
    }

    .header-right {
      text-align: right;
    }

    .header-date {
      font-size: 28px;
      font-weight: bold;
    }

    .header-coverage {
      font-size: 18px;
      color: #aaa;
    }

    .kpi-row {
      display: grid;
      grid-template-columns: 2fr repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .kpi-card {
      background: #111;
      border-radius: 14px;
      padding: 12px 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border: 3px solid #444;
    }

    .kpi-title {
      font-size: 18px;
      margin-bottom: 6px;
    }

    .kpi-main {
      font-size: 26px;
      font-weight: bold;
    }

    .kpi-sub {
      font-size: 14px;
      color: #ccc;
    }

    .status-pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .pill-ok {
      background: #00b050;
      color: #000;
    }

    .pill-nok {
      background: #c00000;
      color: #fff;
    }

    .pill-idle {
      background: #444;
      color: #fff;
    }

    .table-container {
      flex: 1;
      overflow-y: auto;
      border-radius: 10px;
      background: #111;
      padding: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #111;
      color: #fff;
      font-size: 14px;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #222;
      padding: 8px;
      border-bottom: 2px solid #555;
      border-right: 1px solid #555;
    }

    tbody td {
      padding: 6px 4px;
      text-align: center;
      border-bottom: 1px solid #222;
      border-right: 1px solid #222;
    }

    .row-current {
      background: #262626;
    }

    .cell-ok {
      background: #00b050;
    }

    .cell-nok {
      background: #c00000;
    }

    .acc-row {
      background: #003366 !important;
      font-weight: bold;
    }

    .acc-row td {
      border-top: 2px solid #fff;
    }

    .footer-status {
      margin-top: 6px;
      font-size: 14px;
      color: #ccc;
    }
  </style>
</head>
<body>
  <div class="wrapper">

    <div class="header">
      <div class="header-title">Performance CLM6 – Andon</div>
      <div class="header-right">
        <div class="header-date" id="currentDate">--</div>
        <div class="header-coverage" id="coverageText">No production yet</div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-row">
      <!-- Card geral -->
      <div class="kpi-card" id="cardTotal">
        <div class="kpi-title">Total Production vs Target</div>
        <div class="kpi-main" id="totalProd">-</div>
        <div class="kpi-sub" id="totalTarget">Target: -</div>
        <div class="footer-status" id="overallStatus">Status: -</div>
      </div>

      <!-- Line 1 -->
      <div class="kpi-card" id="cardLine1">
        <div class="kpi-title">Line 1</div>
        <div id="pillLine1" class="status-pill pill-idle">IDLE</div>
        <div class="kpi-sub">Last period: <span id="lastL1">-</span></div>
        <div class="kpi-sub">Accumulated: <span id="accL1">-</span></div>
      </div>

      <!-- Line 2 -->
      <div class="kpi-card" id="cardLine2">
        <div class="kpi-title">Line 2</div>
        <div id="pillLine2" class="status-pill pill-idle">IDLE</div>
        <div class="kpi-sub">Last period: <span id="lastL2">-</span></div>
        <div class="kpi-sub">Accumulated: <span id="accL2">-</span></div>
      </div>

      <!-- Line 3 -->
      <div class="kpi-card" id="cardLine3">
        <div class="kpi-title">Line 3</div>
        <div id="pillLine3" class="status-pill pill-idle">IDLE</div>
        <div class="kpi-sub">Last period: <span id="lastL3">-</span></div>
        <div class="kpi-sub">Accumulated: <span id="accL3">-</span></div>
      </div>

      <!-- Line 4 -->
      <div class="kpi-card" id="cardLine4">
        <div class="kpi-title">Line 4</div>
        <div id="pillLine4" class="status-pill pill-idle">IDLE</div>
        <div class="kpi-sub">Last period: <span id="lastL4">-</span></div>
        <div class="kpi-sub">Accumulated: <span id="accL4">-</span></div>
      </div>
    </div>

    <!-- Tabela de slots -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Shift</th>
            <th>Time</th>
            <th>Target</th>
            <th>Line 1</th>
            <th>Line 2</th>
            <th>Line 3</th>
            <th>Line 4</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div class="footer-status" id="lastUpdate">Last update: --</div>
    </div>

  </div>

  <script>
    // URL do Web App (mesma do lançamento)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxugNG9AE1dpoobCrOYFaTzbH3EUVkd1SbbASSdcaG3eZBLuoePB5F0bolIgiCiqqIT/exec";

    function getTodayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function formatDateHeader() {
      const now = new Date();
      const d = String(now.getDate()).padStart(2, "0");
      const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const m = monthNames[now.getMonth()];
      const y = String(now.getFullYear()).slice(-2);
      document.getElementById("currentDate").textContent = `${d}-${m}-${y}`;
    }

    function setCoverage(ultimoSlot) {
      const el = document.getElementById("coverageText");
      if (!ultimoSlot) {
        el.textContent = "No production yet (T1 not started)";
        return;
      }

      if (ultimoSlot.shift === 1) {
        el.textContent = "Shift coverage: T1";
      } else if (ultimoSlot.shift === 2) {
        el.textContent = "Shift coverage: T1 + T2";
      } else {
        el.textContent = "Shift coverage: T1 + T2 + T3";
      }
    }

    function setCardBorder(id, status) {
      const card = document.getElementById(id);
      if (!card) return;
      if (status === "OK") card.style.borderColor = "#00b050";
      else if (status === "NOK") card.style.borderColor = "#c00000";
      else card.style.borderColor = "#666";
    }

    function updateTopKPIs(data) {
      const acumulado = data.acumulado || { target_total: 0, line1: 0, line2: 0, line3: 0, line4: 0 };
      const ultimo = data.ultimo_slot || null;

      // target acumulado por linha (T1, T2, T3 conforme regra do Code.gs)
      const targetPerLine = acumulado.target_total || 0;
      // target da fábrica = target por linha * 4 linhas
      const targetFactory = targetPerLine * 4;

      const totalLines =
        (acumulado.line1 || 0) +
        (acumulado.line2 || 0) +
        (acumulado.line3 || 0) +
        (acumulado.line4 || 0);

      const totalProdEl = document.getElementById("totalProd");
      const totalTargetEl = document.getElementById("totalTarget");
      const overallStatus = document.getElementById("overallStatus");

      if (targetFactory > 0) {
        totalProdEl.textContent = totalLines;
        totalTargetEl.textContent = "Target: " + targetFactory;
      } else {
        totalProdEl.textContent = "-";
        totalTargetEl.textContent = "Target: -";
      }

      let statusTotal = "IDLE";
      if (targetFactory <= 0) {
        overallStatus.textContent = "Status: Waiting for first launch";
      } else if (totalLines >= targetFactory) {
        overallStatus.textContent = "Status: OK";
        statusTotal = "OK";
      } else {
        overallStatus.textContent = "Status: NOK";
        statusTotal = "NOK";
      }
      setCardBorder("cardTotal", statusTotal);

      const lines = [
        { key: "line1", pill: "pillLine1", last: "lastL1", acc: "accL1", card: "cardLine1" },
        { key: "line2", pill: "pillLine2", last: "lastL2", acc: "accL2", card: "cardLine2" },
        { key: "line3", pill: "pillLine3", last: "lastL3", acc: "accL3", card: "cardLine3" },
        { key: "line4", pill: "pillLine4", last: "lastL4", acc: "accL4", card: "cardLine4" }
      ];

      lines.forEach(l => {
        const pill = document.getElementById(l.pill);
        const lastSpan = document.getElementById(l.last);
        const accSpan = document.getElementById(l.acc);

        const accVal = acumulado[l.key] || 0;

        if (!ultimo || targetPerLine <= 0) {
          pill.textContent = "IDLE";
          pill.className = "status-pill pill-idle";
          lastSpan.textContent = "-";
          accSpan.textContent = "-";
          setCardBorder(l.card, "IDLE");
          return;
        }

        const lastSlot = data.slots.find(s => s.id_slot === ultimo.id_slot) || null;
        let lastVal = 0;
        let lastTarget = 0;
        if (lastSlot) {
          lastVal = Number(lastSlot[l.key] || 0);
          lastTarget = Number(lastSlot.target || 0);
        }

        lastSpan.textContent = `${lastVal} / ${lastTarget}`;
        accSpan.textContent = `${accVal} / ${targetPerLine}`;

        let status = "NOK";
        if (accVal >= targetPerLine) {
          pill.textContent = "OK";
          pill.className = "status-pill pill-ok";
          status = "OK";
        } else {
          pill.textContent = "NOK";
          pill.className = "status-pill pill-nok";
          status = "NOK";
        }
        setCardBorder(l.card, status);
      });
    }

    function buildTable(data) {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      const slots = data.slots || [];
      const ultimo = data.ultimo_slot || null;

      slots.forEach(slot => {
        const tr = document.createElement("tr");

        if (ultimo && slot.id_slot === ultimo.id_slot) {
          tr.classList.add("row-current");
        }

        const cShift = document.createElement("td");
        cShift.textContent = "Shift " + slot.shift;
        tr.appendChild(cShift);

        const cTime = document.createElement("td");
        cTime.textContent = slot.label;
        tr.appendChild(cTime);

        const cTarget = document.createElement("td");
        cTarget.textContent = slot.target;
        tr.appendChild(cTarget);

        ["line1", "line2", "line3", "line4"].forEach(k => {
          const td = document.createElement("td");
          const v = Number(slot[k] || 0);
          td.textContent = v > 0 ? v : "";

          if (v > 0) {
            if (v >= slot.target) td.classList.add("cell-ok");
            else td.classList.add("cell-nok");
          }

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      // linha de acumulados
      const ac = data.acumulado || { target_total: 0, line1:0, line2:0, line3:0, line4:0 };
      if (ac.target_total > 0) {
        const accRow = document.createElement("tr");
        accRow.classList.add("acc-row");

        const c1 = document.createElement("td");
        c1.colSpan = 2;
        c1.textContent = "Accumulated";
        accRow.appendChild(c1);

        const c2 = document.createElement("td");
        c2.textContent = ac.target_total; // target por linha
        accRow.appendChild(c2);

        ["line1", "line2", "line3", "line4"].forEach(k => {
          const td = document.createElement("td");
          const v = ac[k] || 0;
          td.textContent = v;
          // comparação com target por linha
          if (v >= ac.target_total) td.classList.add("cell-ok");
          else td.classList.add("cell-nok");
          accRow.appendChild(td);
        });

        tbody.appendChild(accRow);
      }
    }

    async function refreshDashboard() {
      try {
        const today = getTodayISO();
        const res = await fetch(`${SCRIPT_URL}?action=dailyProduction&data=${today}`);
        const json = await res.json();

        if (json.status !== "success") {
          console.error("API error:", json.message);
          document.getElementById("coverageText").textContent = "Error loading data";
          return;
        }

        setCoverage(json.ultimo_slot || null);
        updateTopKPIs(json);
        buildTable(json);

        const now = new Date();
        document.getElementById("lastUpdate").textContent =
          "Last update: " + now.toLocaleTimeString();

      } catch (err) {
        console.error(err);
        document.getElementById("coverageText").textContent = "Error calling API";
      }
    }

    // Inicialização
    formatDateHeader();
    refreshDashboard();
    setInterval(refreshDashboard, 60000);
  </script>
</body>
</html>









