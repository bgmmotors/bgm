<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PERFORMANCE CLM6 – TV COMPACT</title>
  <style>
    /* RESET & BASE */
    html, body { 
      margin: 0; padding: 0; 
      height: 100vh; 
      width: 100vw;
      background: #000; 
      font-family: "Segoe UI", Arial, sans-serif; /* Fonte mais limpa para TV */
      color: #fff; 
      overflow: hidden; /* Bloqueia barras de rolagem */
    }

    .wrapper { 
      display: flex; 
      flex-direction: column; 
      height: 100%; 
      /* Margem de segurança maior para evitar corte da TV (Overscan) */
      padding: 1vh 2vw; 
      box-sizing: border-box; 
      position: relative;
    }

    /* HEADER COMPACTO */
    .header { 
      flex: 0 0 auto; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 4px; 
      height: 36px; /* Reduzido */
      z-index: 10;
    }
    .header-left { display:flex; align-items:center; min-width: 140px; }
    .logo { height: 32px; width: auto; display: block; }

    .header-center { flex:1; display:flex; justify-content:center; align-items:center; }
    .header-title { font-size: 32px; font-weight: 900; letter-spacing: 1px; }

    .header-right { text-align:right; min-width: 280px; }
    .header-date { font-size: 22px; font-weight: 900; color: #ddd; line-height: 1; }
    .header-lang { font-size: 11px; color: #bbb; margin-top: 2px; letter-spacing: 0.8px; }

    /* PAGES */
    .pages { 
      position: relative; 
      flex: 1; 
      display: block; 
      overflow: hidden;
    }
    
    .page {
      position: absolute; inset: 0;
      opacity: 0; pointer-events: none;
      transition: opacity 550ms ease;
      display: flex; flex-direction: column;
    }
    
    .page.active { opacity: 1; pointer-events: auto; }

    /* LABELS */
    .section-label {
      flex: 0 0 auto;
      font-size: 13px;
      font-weight: 900;
      color: #777;
      margin: 2px 0;
      text-transform: uppercase;
      border-bottom: 1px solid #333;
      padding-bottom: 1px;
    }

    /* KPI CARDS (Mais baixos) */
    .kpi-row { 
      flex: 0 0 auto; 
      display: grid; 
      grid-template-columns: 2fr repeat(4, 1fr); 
      gap: 8px; 
      margin-bottom: 6px;
    }

    .kpi-card {
      background: #111;
      border-radius: 10px;
      padding: 6px 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.6);
      border: 2px solid #444; 
      height: 80px; /* Reduzido de 96px para 80px */
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .card-grid { 
      display: grid; 
      grid-template-columns: 1fr auto; 
      gap: 6px; 
      align-items: center; 
      height: 100%;
    }

    /* Tipografia Card Ajustada */
    .kpi-title { 
      font-size: 14px; margin-bottom: 2px; color: #ccc; 
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
    }
    .kpi-main { font-size: 26px; font-weight: 900; line-height: 1; color:#fff; }
    .kpi-sub  { font-size: 11px; color: #999; }

    .metric { margin-top: 2px; }
    .metric-label { font-size: 10px; color: #999; }
    .metric-value { font-size: 14px; font-weight: 900; color: #fff; }

    /* Face + % */
    .right-col {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      width: 50px; 
    }
    .big-face svg { width: 36px; height: 36px; display: block; }
    .face-pct { font-size: 15px; font-weight: 900; color: #fff; margin-top: 2px; }

    /* TABLE */
    .table-container { 
      flex: 1 1 auto; 
      background: #111; 
      border-radius: 8px; 
      padding: 0;
      margin-bottom: 6px;
      border: 1px solid #333;
      overflow-y: hidden; /* Evita scroll na tabela para não quebrar layout, ajusta fonte se precisar */
      display: flex; flex-direction: column;
    }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    
    thead th { 
      position: sticky; top: 0; 
      background: #222; 
      border-bottom: 2px solid #555; 
      border-right: 1px solid #555; 
      z-index: 10;
      padding: 6px 4px;
      font-size: 12px;
    }
    tbody td { 
      text-align: center; 
      border-bottom: 1px solid #222; 
      border-right: 1px solid #222; 
      padding: 4px 2px; /* Padding vertical mínimo */
      height: 24px;
    }

    .row-current { background: #262626; }

    /* Colors */
    .cell-ok  { background: #00b050; color: #000; font-weight: 900; }
    .cell-mid { background: #FFFF00; color: #000; font-weight: 900; }
    .cell-nok { background: #c00000; color: #fff; font-weight: 900; }
    
    .cell-mnt, .cell-mat, .cell-peo, .cell-qual, .cell-nosched { 
      font-weight: 900; font-size: 11px; color:#000; 
    }
    .cell-mnt { background: orange; }
    .cell-mat { background: #808080; }
    .cell-peo { background: #ff69b4; }
    .cell-qual{ background: #ffd400; }
    .cell-nosched { background: #0070c0; color:#fff; }

    /* Summary Row */
    .shift-sum td {
      background: #003366; 
      color: #fff; font-weight: 900; font-size: 14px;
      padding: 8px 4px !important;
      border-top: 3px solid #FFFFFF;
      border-bottom: 3px solid #FFFFFF;
    }
    .shift-sum td.cell-ok { background: #00b050 !important; color: #000; }
    .shift-sum td.cell-mid { background: #FFFF00 !important; color: #000; }
    .shift-sum td.cell-nok { background: #c00000 !important; color: #fff; }

    .face-stroke { stroke: currentColor; stroke-width: 3; fill: none; stroke-linecap: round; stroke-linejoin: round; }

    /* Ajuste fino para telas menores */
    body[data-shifts="1"] table { font-size: 14px; }
  </style>
</head>
<body>

<div class="wrapper">

  <div class="header">
    <div class="header-left">
      <img class="logo" src="assets/BGM.png" alt="BGM">
    </div>
    <div class="header-center">
      <div class="header-title">PERFORMANCE CLM6</div>
    </div>
    <div class="header-right">
      <div class="header-date" id="dateTime">--</div>
      <div class="header-lang" id="langLabel">LANG: ENGLISH</div>
    </div>
  </div>

  <div class="pages">
    
    <div class="page active" id="pageEN" data-lang="en">
      <div class="section-label">GLOBAL RESULTS</div>
      <div class="kpi-row">
        <div class="kpi-card" id="cardTotal_en">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Total vs Target</div>
              <div class="kpi-main" id="totalProd_en">-</div>
              <div class="kpi-sub" id="totalTarget_en">Tgt: -</div>
            </div>
            <div class="right-col"><div class="big-face" id="faceTotal_en"></div><div class="face-pct" id="pctTotal_en"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine1_en">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Line 1</div>
              <div class="metric"><div class="metric-label">Last</div><div class="metric-value" id="lastL1_en">-</div></div>
              <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="accL1_en">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL1_en"></div><div class="face-pct" id="pctL1_en"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine2_en">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Line 2</div>
              <div class="metric"><div class="metric-label">Last</div><div class="metric-value" id="lastL2_en">-</div></div>
              <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="accL2_en">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL2_en"></div><div class="face-pct" id="pctL2_en"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine3_en">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Line 3</div>
              <div class="metric"><div class="metric-label">Last</div><div class="metric-value" id="lastL3_en">-</div></div>
              <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="accL3_en">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL3_en"></div><div class="face-pct" id="pctL3_en"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine4_en">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Line 4</div>
              <div class="metric"><div class="metric-label">Last</div><div class="metric-value" id="lastL4_en">-</div></div>
              <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="accL4_en">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL4_en"></div><div class="face-pct" id="pctL4_en"></div></div>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width:14%;">Shift</th><th style="width:26%;">Time</th><th style="width:12%;">Target</th>
              <th style="width:12%;">Line 1</th><th style="width:12%;">Line 2</th><th style="width:12%;">Line 3</th><th style="width:12%;">Line 4</th>
            </tr>
          </thead>
          <tbody id="tableBody_en"></tbody>
        </table>
      </div>

      <div class="section-label" id="lblShift_en">CURRENT SHIFT RESULTS</div>
      <div class="kpi-row" style="margin-bottom:0;">
        <div class="kpi-card" id="cardTotal_Shift_en">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Shift Total</div>
              <div class="kpi-main" id="totalProd_Shift_en">-</div>
              <div class="kpi-sub" id="totalTarget_Shift_en">Tgt: -</div>
            </div>
            <div class="right-col"><div class="big-face" id="faceTotal_Shift_en"></div><div class="face-pct" id="pctTotal_Shift_en"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine1_Shift_en">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Line 1 (Shift)</div>
              <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="valL1_Shift_en">-</div></div>
              <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL1_Shift_en">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL1_Shift_en"></div><div class="face-pct" id="pctL1_Shift_en"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine2_Shift_en">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Line 2 (Shift)</div>
              <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="valL2_Shift_en">-</div></div>
              <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL2_Shift_en">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL2_Shift_en"></div><div class="face-pct" id="pctL2_Shift_en"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine3_Shift_en">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Line 3 (Shift)</div>
              <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="valL3_Shift_en">-</div></div>
              <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL3_Shift_en">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL3_Shift_en"></div><div class="face-pct" id="pctL3_Shift_en"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine4_Shift_en">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Line 4 (Shift)</div>
              <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="valL4_Shift_en">-</div></div>
              <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL4_Shift_en">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL4_Shift_en"></div><div class="face-pct" id="pctL4_Shift_en"></div></div>
          </div>
        </div>
      </div>
    </div>

    <div class="page" id="pageBG" data-lang="bg">
      <div class="section-label">ГЛОБАЛНИ РЕЗУЛТАТИ</div>
      <div class="kpi-row">
        <div class="kpi-card" id="cardTotal_bg">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Общо Производство</div>
              <div class="kpi-main" id="totalProd_bg">-</div>
              <div class="kpi-sub" id="totalTarget_bg">Цел: -</div>
            </div>
            <div class="right-col"><div class="big-face" id="faceTotal_bg"></div><div class="face-pct" id="pctTotal_bg"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine1_bg">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Линия 1</div>
              <div class="metric"><div class="metric-label">Последен</div><div class="metric-value" id="lastL1_bg">-</div></div>
              <div class="metric"><div class="metric-label">Натрупано</div><div class="metric-value" id="accL1_bg">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL1_bg"></div><div class="face-pct" id="pctL1_bg"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine2_bg">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Линия 2</div>
              <div class="metric"><div class="metric-label">Последен</div><div class="metric-value" id="lastL2_bg">-</div></div>
              <div class="metric"><div class="metric-label">Натрупано</div><div class="metric-value" id="accL2_bg">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL2_bg"></div><div class="face-pct" id="pctL2_bg"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine3_bg">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Линия 3</div>
              <div class="metric"><div class="metric-label">Последен</div><div class="metric-value" id="lastL3_bg">-</div></div>
              <div class="metric"><div class="metric-label">Натрупано</div><div class="metric-value" id="accL3_bg">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL3_bg"></div><div class="face-pct" id="pctL3_bg"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine4_bg">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Линия 4</div>
              <div class="metric"><div class="metric-label">Последен</div><div class="metric-value" id="lastL4_bg">-</div></div>
              <div class="metric"><div class="metric-label">Натрупано</div><div class="metric-value" id="accL4_bg">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL4_bg"></div><div class="face-pct" id="pctL4_bg"></div></div>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width:14%;">Смяна</th><th style="width:26%;">Период</th><th style="width:12%;">Цел</th>
              <th style="width:12%;">Линия 1</th><th style="width:12%;">Линия 2</th><th style="width:12%;">Линия 3</th><th style="width:12%;">Линия 4</th>
            </tr>
          </thead>
          <tbody id="tableBody_bg"></tbody>
        </table>
      </div>

      <div class="section-label" id="lblShift_bg">РЕЗУЛТАТИ ОТ ТЕКУЩА СМЯНА</div>
      <div class="kpi-row" style="margin-bottom:0;">
        <div class="kpi-card" id="cardTotal_Shift_bg">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Общо Смяна</div>
              <div class="kpi-main" id="totalProd_Shift_bg">-</div>
              <div class="kpi-sub" id="totalTarget_Shift_bg">Цел: -</div>
            </div>
            <div class="right-col"><div class="big-face" id="faceTotal_Shift_bg"></div><div class="face-pct" id="pctTotal_Shift_bg"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine1_Shift_bg">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Линия 1 (Смяна)</div>
              <div class="metric"><div class="metric-label">Натр</div><div class="metric-value" id="valL1_Shift_bg">-</div></div>
              <div class="metric"><div class="metric-label">Цел</div><div class="metric-value" id="tgtL1_Shift_bg">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL1_Shift_bg"></div><div class="face-pct" id="pctL1_Shift_bg"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine2_Shift_bg">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Линия 2 (Смяна)</div>
              <div class="metric"><div class="metric-label">Натр</div><div class="metric-value" id="valL2_Shift_bg">-</div></div>
              <div class="metric"><div class="metric-label">Цел</div><div class="metric-value" id="tgtL2_Shift_bg">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL2_Shift_bg"></div><div class="face-pct" id="pctL2_Shift_bg"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine3_Shift_bg">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Линия 3 (Смяна)</div>
              <div class="metric"><div class="metric-label">Натр</div><div class="metric-value" id="valL3_Shift_bg">-</div></div>
              <div class="metric"><div class="metric-label">Цел</div><div class="metric-value" id="tgtL3_Shift_bg">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL3_Shift_bg"></div><div class="face-pct" id="pctL3_Shift_bg"></div></div>
          </div>
        </div>
        <div class="kpi-card" id="cardLine4_Shift_bg">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Линия 4 (Смяна)</div>
              <div class="metric"><div class="metric-label">Натр</div><div class="metric-value" id="valL4_Shift_bg">-</div></div>
              <div class="metric"><div class="metric-label">Цел</div><div class="metric-value" id="tgtL4_Shift_bg">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL4_Shift_bg"></div><div class="face-pct" id="pctL4_Shift_bg"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxugNG9AE1dpoobCrOYFaTzbH3EUVkd1SbbASSdcaG3eZBLuoePB5F0bolIgiCiqqIT/exec";
  const ROTATE_MS = 30000;

  function qs(name){
    const u = new URL(window.location.href);
    return (u.searchParams.get(name) || "").trim().toLowerCase();
  }

  function getTodayISO() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function startDateTime() {
    const el = document.getElementById("dateTime");
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    function tick() {
      const now = new Date();
      const d = String(now.getDate()).padStart(2, "0");
      const m = monthNames[now.getMonth()];
      const y = String(now.getFullYear()).slice(-2);
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      el.textContent = `${d}-${m}-${y}  ${hh}:${mm}`;
    }
    tick();
    setInterval(tick, 1000);
  }

  function faceSVG(type) {
    const common = `class="face-stroke"`;
    const head = `<circle cx="32" cy="32" r="22" ${common}></circle>`;
    const eyes = `<circle cx="24" cy="28" r="2" ${common}></circle><circle cx="40" cy="28" r="2" ${common}></circle>`;
    let mouth = "";
    if (type === "happy") mouth = `<path d="M22 38 Q32 46 42 38" ${common}></path>`;
    else if (type === "neutral") mouth = `<path d="M22 40 L42 40" ${common}></path>`;
    else mouth = `<path d="M22 44 Q32 36 42 44" ${common}></path>`;
    return `<svg viewBox="0 0 64 64" aria-hidden="true">${head}${eyes}${mouth}</svg>`;
  }

  function perfStatus(pct) {
    if (pct >= 1) return { status:"OK", cls:"cell-ok", face:"happy" };
    if (pct >= 0.95) return { status:"MID", cls:"cell-mid", face:"neutral" };
    return { status:"NOK", cls:"cell-nok", face:"sad" };
  }

  function statusClass(kind) {
    if (kind === "STOP_MAINT") return "cell-mnt";
    if (kind === "STOP_MAT") return "cell-mat";
    if (kind === "STOP_PEO") return "cell-peo";
    if (kind === "STOP_QUAL") return "cell-qual";
    if (kind === "NO_SCHEDULE") return "cell-nosched";
    return "";
  }

  function translateStopText(lang, text){
    const t = String(text || "").trim();
    if (!t) return "";
    if (lang !== "bg") return t;
    const map = {
      "STOP – MAINTENANCE": "СТОП – ПОДДРЪЖКА",
      "STOP - MAINTENANCE": "СТОП – ПОДДРЪЖКА",
      "STOP – MATERIAL":    "СТОП – МАТЕРИАЛ",
      "STOP - MATERIAL":    "СТОП – МАТЕРИАЛ",
      "STOP – PEOPLE":      "СТОП – ПЕРСОНАЛ",
      "STOP - PEOPLE":      "СТОП – ПЕРСОНАЛ",
      "STOP – QUALITY":     "СТОП – КАЧЕСТВО",
      "STOP - QUALITY":     "СТОП – КАЧЕСТВО",
      "NO SCHEDULE":        "БЕЗ ПЛАН"
    };
    const normalized = t.replace(/—/g, "–");
    return map[normalized] || map[t] || t;
  }

  function updateCardUI(lang, cardId, faceId, pctId, statusObj, percentage) {
    const card = document.getElementById(cardId + "_" + lang);
    const face = document.getElementById(faceId + "_" + lang);
    const pct  = document.getElementById(pctId + "_" + lang);
    if(!card || !face || !pct) return;

    if (!statusObj) {
      card.style.borderColor = "#444";
      face.innerHTML = "";
      pct.textContent = "";
      return;
    }
    if (statusObj.status === "OK") card.style.borderColor = "#00b050";
    else if (statusObj.status === "MID") card.style.borderColor = "#FFFF00";
    else card.style.borderColor = "#c00000";

    face.style.color = (statusObj.status === "NOK") ? "#c00000" : (statusObj.status === "MID" ? "#FFFF00" : "#00b050");
    face.innerHTML = faceSVG(statusObj.face);
    pct.textContent = Math.round(percentage) + "%";
  }

  function hasAnyLaunchInSlot(slot) { return slot && slot.has_launch === true; }
  function countedTarget(slot){ return Number(slot && slot.target_counted ? slot.target_counted : 0); }
  function calcUpToUltimo(slots, ultimo) {
    if (!ultimo) return slots; 
    const out = [];
    for (const s of slots) {
      out.push(s);
      if (s.id_slot === ultimo.id_slot) break;
    }
    return out;
  }

  function tdWithPerf(value, targetEff, hasLaunch) {
    const td = document.createElement("td");
    if (!hasLaunch) { td.textContent = ""; return td; }
    if (targetEff > 0) {
      const st = perfStatus(value / targetEff);
      td.classList.add(st.cls);
      td.textContent = value;
    } else {
      td.textContent = String(value ?? "");
    }
    return td;
  }

  function tdSummaryWithPerf(value, targetEff) {
    const td = document.createElement("td");
    if (targetEff <= 0) { td.textContent = (value > 0) ? value : ""; return td; }
    const ratio = value / targetEff;
    const st = perfStatus(ratio);
    td.classList.add(st.cls);
    const pct = Math.round(ratio * 100);
    td.innerHTML = `${value} <span style="font-size:0.9em">(${pct}%)</span>`;
    return td;
  }

  function updateAllKPIsFor(lang, json, activeShift) {
    const allSlots = json.slots || [];
    const ultimo = json.ultimo_slot || null;
    const anyLaunchDay = allSlots.some(s => hasAnyLaunchInSlot(s));

    const globalConsidered = calcUpToUltimo(allSlots, ultimo);
    const globalTargetPerLine = globalConsidered.reduce((acc, s) => acc + countedTarget(s), 0);
    const globalProd = {
      line1: globalConsidered.reduce((a,s)=>a + Number(s.line1||0),0),
      line2: globalConsidered.reduce((a,s)=>a + Number(s.line2||0),0),
      line3: globalConsidered.reduce((a,s)=>a + Number(s.line3||0),0),
      line4: globalConsidered.reduce((a,s)=>a + Number(s.line4||0),0)
    };
    const globalTotalProd = globalProd.line1 + globalProd.line2 + globalProd.line3 + globalProd.line4;
    const globalTotalTarget = globalTargetPerLine * 4;
    const lastSlot = ultimo ? allSlots.find(s => s.id_slot === ultimo.id_slot) : null;

    const elTotalProd = document.getElementById("totalProd_" + lang);
    const elTotalTarget = document.getElementById("totalTarget_" + lang);
    const targetPrefix = (lang === "bg") ? "Цел: " : "Tgt: ";

    if (!anyLaunchDay || globalTotalTarget <= 0) {
       elTotalProd.textContent = "-";
       elTotalTarget.textContent = targetPrefix + "-";
       updateCardUI(lang, "cardTotal", "faceTotal", "pctTotal", null, null);
    } else {
       elTotalProd.textContent = globalTotalProd;
       elTotalTarget.textContent = targetPrefix + globalTotalTarget;
       const p = globalTotalProd / globalTotalTarget;
       updateCardUI(lang, "cardTotal", "faceTotal", "pctTotal", perfStatus(p), p*100);
    }

    const globalLines = [
      { key:"line1", lastId:"lastL1", accId:"accL1", card:"cardLine1", face:"faceL1", pct:"pctL1" },
      { key:"line2", lastId:"lastL2", accId:"accL2", card:"cardLine2", face:"faceL2", pct:"pctL2" },
      { key:"line3", lastId:"lastL3", accId:"accL3", card:"cardLine3", face:"faceL3", pct:"pctL3" },
      { key:"line4", lastId:"lastL4", accId:"accL4", card:"cardLine4", face:"faceL4", pct:"pctL4" }
    ];
    globalLines.forEach(m => {
      const lastVal = lastSlot ? Number(lastSlot[m.key] || 0) : 0;
      const lastTgt = lastSlot ? Number(lastSlot.target_effective || lastSlot.target || 0) : 0;
      document.getElementById(m.lastId + "_" + lang).textContent = lastSlot ? `${lastVal}/${lastTgt}` : "-";
      document.getElementById(m.accId + "_" + lang).textContent = anyLaunchDay ? `${globalProd[m.key]}/${globalTargetPerLine}` : "-";
      
      if (!anyLaunchDay || globalTotalTarget <= 0) {
        updateCardUI(lang, m.card, m.face, m.pct, null, null);
      } else {
        const p = globalProd[m.key] / globalTargetPerLine;
        updateCardUI(lang, m.card, m.face, m.pct, perfStatus(p), p*100);
      }
    });

    const shiftSlotsAll = allSlots.filter(s => Number(s.shift) === activeShift);
    const shiftConsidered = calcUpToUltimo(shiftSlotsAll, ultimo);
    const anyLaunchShift = shiftConsidered.some(s => hasAnyLaunchInSlot(s));
    const shiftTargetPerLine = shiftConsidered.reduce((acc, s) => acc + countedTarget(s), 0);
    const shiftProd = {
      line1: shiftConsidered.reduce((a,s)=>a + Number(s.line1||0),0),
      line2: shiftConsidered.reduce((a,s)=>a + Number(s.line2||0),0),
      line3: shiftConsidered.reduce((a,s)=>a + Number(s.line3||0),0),
      line4: shiftConsidered.reduce((a,s)=>a + Number(s.line4||0),0)
    };
    const shiftTotalProd = shiftProd.line1 + shiftProd.line2 + shiftProd.line3 + shiftProd.line4;
    const shiftTotalTarget = shiftTargetPerLine * 4;

    const elShiftTotal = document.getElementById("totalProd_Shift_" + lang);
    const elShiftTarget = document.getElementById("totalTarget_Shift_" + lang);
    if (!anyLaunchShift || shiftTotalTarget <= 0) {
       elShiftTotal.textContent = "-";
       elShiftTarget.textContent = targetPrefix + "-";
       updateCardUI(lang, "cardTotal_Shift", "faceTotal_Shift", "pctTotal_Shift", null, null);
    } else {
       elShiftTotal.textContent = shiftTotalProd;
       elShiftTarget.textContent = targetPrefix + shiftTotalTarget;
       const p = shiftTotalProd / shiftTotalTarget;
       updateCardUI(lang, "cardTotal_Shift", "faceTotal_Shift", "pctTotal_Shift", perfStatus(p), p*100);
    }

    const shiftLines = [
      { key:"line1", valId:"valL1_Shift", tgtId:"tgtL1_Shift", card:"cardLine1_Shift", face:"faceL1_Shift", pct:"pctL1_Shift" },
      { key:"line2", valId:"valL2_Shift", tgtId:"tgtL2_Shift", card:"cardLine2_Shift", face:"faceL2_Shift", pct:"pctL2_Shift" },
      { key:"line3", valId:"valL3_Shift", tgtId:"tgtL3_Shift", card:"cardLine3_Shift", face:"faceL3_Shift", pct:"pctL3_Shift" },
      { key:"line4", valId:"valL4_Shift", tgtId:"tgtL4_Shift", card:"cardLine4_Shift", face:"faceL4_Shift", pct:"pctL4_Shift" }
    ];
    shiftLines.forEach(m => {
      document.getElementById(m.tgtId + "_" + lang).textContent = shiftTargetPerLine > 0 ? shiftTargetPerLine : "-";
      document.getElementById(m.valId + "_" + lang).textContent = anyLaunchShift ? shiftProd[m.key] : "-";
      if (!anyLaunchShift || shiftTotalTarget <= 0) {
        updateCardUI(lang, m.card, m.face, m.pct, null, null);
      } else {
        const p = shiftProd[m.key] / shiftTargetPerLine;
        updateCardUI(lang, m.card, m.face, m.pct, perfStatus(p), p*100);
      }
    });
  }

  function applyShiftDensity(json){
    const used = [1,2,3].filter(s => (json.slots || []).some(x => Number(x.shift) === s)).length || 1;
    document.body.dataset.shifts = String(used);
  }

  function buildTableFor(lang, json, activeShift) {
    const tbody = document.getElementById(`tableBody_${lang}`);
    tbody.innerHTML = "";
    const slots = json.slots || [];
    const ultimo = json.ultimo_slot || null;
    const shifts = [1,2,3].map(s => ({ shift:s, slots: slots.filter(x => Number(x.shift) === s) }));

    shifts.forEach(group => {
      if (group.shift > activeShift) return; 
      const isCurrentShift = (group.shift === activeShift);

      if (isCurrentShift) {
        group.slots.forEach(slot => {
          const tr = document.createElement("tr");
          if (ultimo && slot.id_slot === ultimo.id_slot) tr.classList.add("row-current");
          
          const tdShift = document.createElement("td"); 
          tdShift.textContent = (lang==="bg"?"Смяна ":"Shift ") + slot.shift; 
          tr.appendChild(tdShift);
          
          const tdTime = document.createElement("td"); tdTime.textContent = slot.label; tr.appendChild(tdTime);
          
          const targetEff = Number(slot.target_effective || 0);
          const tdTarget = document.createElement("td"); tdTarget.textContent = targetEff > 0 ? targetEff : ""; tr.appendChild(tdTarget);

          const defs = [
            { key:"line1", disp:"disp1", st:"st1" },
            { key:"line2", disp:"disp2", st:"st2" },
            { key:"line3", disp:"disp3", st:"st3" },
            { key:"line4", disp:"disp4", st:"st4" }
          ];
          defs.forEach(d => {
            const stKind = slot[d.st] || "RUN";
            if (stKind !== "RUN") {
              const td = document.createElement("td"); 
              td.textContent = translateStopText(lang, slot[d.disp] || ""); 
              td.classList.add(statusClass(stKind)); tr.appendChild(td); return;
            }
            if (!hasAnyLaunchInSlot(slot)) {
              const td = document.createElement("td"); td.textContent = ""; tr.appendChild(td); return;
            }
            const raw = slot[d.key];
            const v = (raw === "" || raw === null || raw === undefined) ? 0 : Number(raw);
            tr.appendChild(tdWithPerf(v, targetEff, true));
          });
          tbody.appendChild(tr);
        });
      }

      if (group.slots.length > 0) {
        const hasAnyLaunchShift = group.slots.some(s => hasAnyLaunchInSlot(s));
        const sumTargetCounted = group.slots.reduce((a,s)=>a + countedTarget(s), 0);
        const sum = {
          target: sumTargetCounted,
          line1: group.slots.reduce((a,s)=>a + Number(s.line1||0),0),
          line2: group.slots.reduce((a,s)=>a + Number(s.line2||0),0),
          line3: group.slots.reduce((a,s)=>a + Number(s.line3||0),0),
          line4: group.slots.reduce((a,s)=>a + Number(s.line4||0),0)
        };
        const trSum = document.createElement("tr"); trSum.classList.add("shift-sum");
        const td1 = document.createElement("td"); td1.colSpan = 2; 
        td1.innerHTML = (lang==="bg") 
          ? `НАТРУПАНО &ndash; СМЯНА ${group.shift}`
          : `CUMULATIVE RESULT &ndash; SHIFT ${group.shift}`;
        trSum.appendChild(td1);
        const tdT = document.createElement("td"); tdT.textContent = sum.target > 0 ? sum.target : ""; trSum.appendChild(tdT);

        ["line1","line2","line3","line4"].forEach(k => {
          if (!hasAnyLaunchShift || sum.target <= 0) {
            const td = document.createElement("td"); td.textContent = ""; trSum.appendChild(td); return;
          }
          trSum.appendChild(tdSummaryWithPerf(sum[k], sum.target));
        });
        tbody.appendChild(trSum);
      }
    });
  }

  async function refresh() {
    try {
      const today = getTodayISO();
      const res = await fetch(`${SCRIPT_URL}?action=dailyProduction&data=${today}`);
      const json = await res.json();
      if (json.status !== "success") return;
      
      let activeShift = 1;
      if (json.ultimo_slot) activeShift = Number(json.ultimo_slot.shift);

      applyShiftDensity(json);
      
      buildTableFor("en", json, activeShift);
      buildTableFor("bg", json, activeShift);
      
      updateAllKPIsFor("en", json, activeShift);
      updateAllKPIsFor("bg", json, activeShift);

    } catch (err) { console.error(err); }
  }

  const pageEN = document.getElementById("pageEN");
  const pageBG = document.getElementById("pageBG");
  const langLabel = document.getElementById("langLabel");

  function show(lang){
    const isEN = (lang === "en");
    pageEN.classList.toggle("active", isEN);
    pageBG.classList.toggle("active", !isEN);
    langLabel.textContent = isEN ? "LANG: ENGLISH" : "ЕЗИК: БЪЛГАРСКИ";
  }

  function startRotation(){
    const forced = qs("lang");
    if (forced === "en") { show("en"); return; }
    if (forced === "bg") { show("bg"); return; }
    
    let cur = "en";
    show(cur);
    setInterval(() => {
      cur = (cur === "en") ? "bg" : "en";
      show(cur);
    }, ROTATE_MS);
  }

  startDateTime();
  refresh();
  setInterval(refresh, 30000);
  startRotation();
</script>
</body>
</html><!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>PERFORMANCE CLM6 - ANDON TV FINAL</title>

  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100vh; width: 100vw;
      background: #000;
      font-family: Arial, Helvetica, sans-serif;
      color: #fff;
      overflow: hidden;
    }

    :root{
      --col-shift: 9%;
      --col-time: 19%;
      --col-target: 7%;
      --col-res: 13%; /* 5 colunas resultados = 65% */
    }

    .wrapper{
      display:flex;
      flex-direction:column;
      height:100%;
      padding:10px 16px;
      box-sizing:border-box;
    }

    /* HEADER */
    .header{
      flex:0 0 auto;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      height:44px;
    }
    .logo{ height:38px; width:auto; display:block; }
    .header-title{ font-size:36px; font-weight:900; letter-spacing:1px; }
    .header-date{ font-size:24px; font-weight:900; color:#ddd; }

    /* LABELS */
    .section-label{
      flex:0 0 auto;
      font-size:14px;
      font-weight:900;
      color:#777;
      margin:4px 0;
      text-transform:uppercase;
      border-bottom:1px solid #333;
      padding-bottom:2px;
    }

    /* KPI ROW alinhada com tabela */
    .kpi-row{
      flex:0 0 auto;
      display:grid;
      grid-template-columns: var(--col-shift) var(--col-time) var(--col-target) repeat(5, var(--col-res));
      gap:10px;
      margin-bottom:8px;
      align-items:stretch;
    }
    .kpi-spacer{ background:transparent; }

    .kpi-card{
      background:#111;
      border-radius:12px;
      padding:8px 12px;
      box-shadow:0 0 8px rgba(0,0,0,0.6);
      border:2px solid #444;
      height:96px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      box-sizing:border-box;
    }

    .card-grid{
      display:grid;
      grid-template-columns:1fr auto;
      gap:8px;
      align-items:center;
      height:100%;
    }

    .kpi-title{ font-size:15px; margin-bottom:4px; color:#ccc; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .kpi-main{ font-size:30px; font-weight:900; line-height:1; color:#fff; }
    .kpi-sub { font-size:12px; color:#999; }

    .metric{ margin-top:4px; }
    .metric-label{ font-size:11px; color:#999; }
    .metric-value{ font-size:15px; font-weight:900; color:#fff; }

    .right-col{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      width:60px;
    }
    .big-face svg{ width:42px; height:42px; display:block; }
    .face-pct{ font-size:17px; font-weight:900; color:#fff; margin-top:3px; }

    /* TABELA */
    .table-container{
      flex:1 1 auto;
      background:#111;
      border-radius:10px;
      padding:0;
      margin-bottom:8px;
      border:1px solid #333;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
    }

    table{ width:100%; border-collapse:collapse; font-size:14px; }

    thead th{
      position:sticky; top:0;
      background:#222;
      border-bottom:2px solid #555;
      border-right:1px solid #555;
      z-index:10;
      padding:8px 6px;
      font-size:13px;
    }

    tbody td{
      text-align:center;
      border-bottom:1px solid #222;
      border-right:1px solid #222;
      padding:6px 4px;
      height:28px;
    }

    .row-current{ background:#262626; }

    .cell-ok { background:#00b050; color:#000; font-weight:900; }
    .cell-mid{ background:#FFFF00; color:#000; font-weight:900; }
    .cell-nok{ background:#c00000; color:#fff; font-weight:900; }

    .cell-mnt,.cell-mat,.cell-peo,.cell-qual,.cell-nosched{
      font-weight:900; font-size:12px; color:#000;
    }
    .cell-mnt{ background:orange; }
    .cell-mat{ background:#808080; }
    .cell-peo{ background:#ff69b4; }
    .cell-qual{ background:#ffd400; }
    .cell-nosched{ background:#0070c0; color:#fff; }

    .shift-sum td{
      background:#003366;
      color:#fff; font-weight:900; font-size:15px;
      padding:10px 4px !important;
      border-top:3px solid #FFFFFF;
      border-bottom:3px solid #FFFFFF;
    }
    .shift-sum td.cell-ok { background:#00b050 !important; color:#000; }
    .shift-sum td.cell-mid{ background:#FFFF00 !important; color:#000; }
    .shift-sum td.cell-nok{ background:#c00000 !important; color:#fff; }

    .face-stroke{
      stroke:currentColor; stroke-width:3; fill:none;
      stroke-linecap:round; stroke-linejoin:round;
    }

    body[data-shifts="1"] table{ font-size:15px; }
  </style>
</head>

<body>
<div class="wrapper">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <img class="logo" src="assets/BGM.png" alt="BGM">
    </div>
    <div class="header-center">
      <div class="header-title">PERFORMANCE CLM6</div>
    </div>
    <div class="header-right">
      <div class="header-date" id="dateTime">--</div>
    </div>
  </div>

  <!-- (INVERTIDO) SHIFT EM CIMA -->
  <div class="section-label">CURRENT SHIFT RESULTS</div>
  <div class="kpi-row" id="rowShift">
    <div class="kpi-spacer"></div>
    <div class="kpi-spacer"></div>
    <div class="kpi-spacer"></div>

    <div class="kpi-card" id="cardLine1_Shift">
      <div class="card-grid">
        <div>
          <div class="kpi-title">Line 1 (Shift)</div>
          <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="valL1_Shift">-</div></div>
          <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL1_Shift">-</div></div>
        </div>
        <div class="right-col"><div class="big-face" id="faceL1_Shift"></div><div class="face-pct" id="pctL1_Shift"></div></div>
      </div>
    </div>

    <div class="kpi-card" id="cardLine2_Shift">
      <div class="card-grid">
        <div>
          <div class="kpi-title">Line 2 (Shift)</div>
          <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="valL2_Shift">-</div></div>
          <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL2_Shift">-</div></div>
        </div>
        <div class="right-col"><div class="big-face" id="faceL2_Shift"></div><div class="face-pct" id="pctL2_Shift"></div></div>
      </div>
    </div>

    <div class="kpi-card" id="cardLine3_Shift">
      <div class="card-grid">
        <div>
          <div class="kpi-title">Line 3 (Shift)</div>
          <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="valL3_Shift">-</div></div>
          <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL3_Shift">-</div></div>
        </div>
        <div class="right-col"><div class="big-face" id="faceL3_Shift"></div><div class="face-pct" id="pctL3_Shift"></div></div>
      </div>
    </div>

    <div class="kpi-card" id="cardLine4_Shift">
      <div class="card-grid">
        <div>
          <div class="kpi-title">Line 4 (Shift)</div>
          <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="valL4_Shift">-</div></div>
          <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL4_Shift">-</div></div>
        </div>
        <div class="right-col"><div class="big-face" id="faceL4_Shift"></div><div class="face-pct" id="pctL4_Shift"></div></div>
      </div>
    </div>

    <div class="kpi-card" id="cardTotal_Shift">
      <div class="card-grid">
        <div>
          <div class="kpi-title">Shift Total</div>
          <div class="kpi-main" id="totalProd_Shift">-</div>
          <div class="kpi-sub" id="totalTarget_Shift">Tgt: -</div>
        </div>
        <div class="right-col">
          <div class="big-face" id="faceTotal_Shift"></div>
          <div class="face-pct" id="pctTotal_Shift"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TABELA -->
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th style="width:var(--col-shift);">Shift</th>
          <th style="width:var(--col-time);">Time</th>
          <th style="width:var(--col-target);">Target</th>
          <th style="width:var(--col-res);">Line 1</th>
          <th style="width:var(--col-res);">Line 2</th>
          <th style="width:var(--col-res);">Line 3</th>
          <th style="width:var(--col-res);">Line 4</th>
          <th style="width:var(--col-res);">Total</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- (INVERTIDO) GLOBAL EM BAIXO -->
  <div class="section-label">GLOBAL RESULTS</div>
  <div class="kpi-row" id="rowGlobal" style="margin-bottom:0;">
    <div class="kpi-spacer"></div>
    <div class="kpi-spacer"></div>
    <div class="kpi-spacer"></div>

    <div class="kpi-card" id="cardLine1">
      <div class="card-grid">
        <div>
          <div class="kpi-title">Line 1</div>
          <div class="metric"><div class="metric-label">Last</div><div class="metric-value" id="lastL1">-</div></div>
          <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="accL1">-</div></div>
        </div>
        <div class="right-col"><div class="big-face" id="faceL1"></div><div class="face-pct" id="pctL1"></div></div>
      </div>
    </div>

    <div class="kpi-card" id="cardLine2">
      <div class="card-grid">
        <div>
          <div class="kpi-title">Line 2</div>
          <div class="metric"><div class="metric-label">Last</div><div class="metric-value" id="lastL2">-</div></div>
          <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="accL2">-</div></div>
        </div>
        <div class="right-col"><div class="big-face" id="faceL2"></div><div class="face-pct" id="pctL2"></div></div>
      </div>
    </div>

    <div class="kpi-card" id="cardLine3">
      <div class="card-grid">
        <div>
          <div class="kpi-title">Line 3</div>
          <div class="metric"><div class="metric-label">Last</div><div class="metric-value" id="lastL3">-</div></div>
          <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="accL3">-</div></div>
        </div>
        <div class="right-col"><div class="big-face" id="faceL3"></div><div class="face-pct" id="pctL3"></div></div>
      </div>
    </div>

    <div class="kpi-card" id="cardLine4">
      <div class="card-grid">
        <div>
          <div class="kpi-title">Line 4</div>
          <div class="metric"><div class="metric-label">Last</div><div class="metric-value" id="lastL4">-</div></div>
          <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="accL4">-</div></div>
        </div>
        <div class="right-col"><div class="big-face" id="faceL4"></div><div class="face-pct" id="pctL4"></div></div>
      </div>
    </div>

    <div class="kpi-card" id="cardTotal">
      <div class="card-grid">
        <div>
          <div class="kpi-title">Total vs Target</div>
          <div class="kpi-main" id="totalProd">-</div>
          <div class="kpi-sub" id="totalTarget">Tgt: -</div>
        </div>
        <div class="right-col">
          <div class="big-face" id="faceTotal"></div>
          <div class="face-pct" id="pctTotal"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxugNG9AE1dpoobCrOYFaTzbH3EUVkd1SbbASSdcaG3eZBLuoePB5F0bolIgiCiqqIT/exec";

  function getTodayISO() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function startDateTime() {
    const el = document.getElementById("dateTime");
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    function tick() {
      const now = new Date();
      const d = String(now.getDate()).padStart(2, "0");
      const m = monthNames[now.getMonth()];
      const y = String(now.getFullYear()).slice(-2);
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      el.textContent = `${d}-${m}-${y}  ${hh}:${mm}`;
    }
    tick();
    setInterval(tick, 1000);
  }

  function faceSVG(type) {
    const common = `class="face-stroke"`;
    const head = `<circle cx="32" cy="32" r="22" ${common}></circle>`;
    const eyes = `<circle cx="24" cy="28" r="2" ${common}></circle><circle cx="40" cy="28" r="2" ${common}></circle>`;
    let mouth = "";
    if (type === "happy") mouth = `<path d="M22 38 Q32 46 42 38" ${common}></path>`;
    else if (type === "neutral") mouth = `<path d="M22 40 L42 40" ${common}></path>`;
    else mouth = `<path d="M22 44 Q32 36 42 44" ${common}></path>`;
    return `<svg viewBox="0 0 64 64" aria-hidden="true">${head}${eyes}${mouth}</svg>`;
  }

  function perfStatus(pct) {
    if (pct >= 1) return { status:"OK", cls:"cell-ok", face:"happy" };
    if (pct >= 0.95) return { status:"MID", cls:"cell-mid", face:"neutral" };
    return { status:"NOK", cls:"cell-nok", face:"sad" };
  }

  function statusClass(kind) {
    if (kind === "STOP_MAINT") return "cell-mnt";
    if (kind === "STOP_MAT") return "cell-mat";
    if (kind === "STOP_PEO") return "cell-peo";
    if (kind === "STOP_QUAL") return "cell-qual";
    if (kind === "NO_SCHEDULE") return "cell-nosched";
    return "";
  }

  function updateCardUI(cardId, faceId, pctId, statusObj, percentage) {
    const card = document.getElementById(cardId);
    const face = document.getElementById(faceId);
    const pct  = document.getElementById(pctId);
    if(!card || !face || !pct) return;

    if (!statusObj) {
      card.style.borderColor = "#444";
      face.innerHTML = "";
      pct.textContent = "";
      return;
    }

    if (statusObj.status === "OK") card.style.borderColor = "#00b050";
    else if (statusObj.status === "MID") card.style.borderColor = "#FFFF00";
    else card.style.borderColor = "#c00000";

    face.style.color = (statusObj.status === "NOK") ? "#c00000" : (statusObj.status === "MID" ? "#FFFF00" : "#00b050");
    face.innerHTML = faceSVG(statusObj.face);
    pct.textContent = Math.round(percentage) + "%";
  }

  function hasAnyLaunchInSlot(slot) { return slot && slot.has_launch === true; }
  function countedTarget(slot){ return Number(slot && slot.target_counted ? slot.target_counted : 0); }

  function calcUpToUltimo(slots, ultimo) {
    if (!ultimo) return slots;
    const out = [];
    for (const s of slots) {
      out.push(s);
      if (s.id_slot === ultimo.id_slot) break;
    }
    return out;
  }

  /* =========================
     LINHAS ATIVAS (REGRA .5)
     ========================= */
  function hasInactiveCode(dispText){
    const s = String(dispText || "");
    return /[.,]5|5[.,]/.test(s); // .5 5. ,5 5,
  }

  function isLineActive(slot, stKind, dispText){
    if (stKind === "RUN") return true;
    // Parada só vira não-ativa se tiver código .5/5./,5/5,
    return !hasInactiveCode(dispText);
  }

  function isThisLineActive(slot, idx){ // idx 1..4
    const stKind = slot[`st${idx}`] || "RUN";
    const disp = slot[`disp${idx}`] || "";
    return isLineActive(slot, stKind, disp);
  }

  function activeLinesCount(slot){
    let n = 0;
    for (let i=1;i<=4;i++){
      if (isThisLineActive(slot, i)) n++;
    }
    return n;
  }

  function sumLineIfActive(slots, idx){
    return slots.reduce((acc, s) => acc + (isThisLineActive(s, idx) ? Number(s[`line${idx}`] || 0) : 0), 0);
  }

  function sumTotalActive(slots){
    return slots.reduce((acc, s) => {
      let v = 0;
      for (let i=1;i<=4;i++){
        if (isThisLineActive(s, i)) v += Number(s[`line${i}`] || 0);
      }
      return acc + v;
    }, 0);
  }

  function targetForLine(slots, idx){
    return slots.reduce((acc, s) => acc + (isThisLineActive(s, idx) ? countedTarget(s) : 0), 0);
  }

  function targetTotalWeighted(slots){
    return slots.reduce((acc, s) => acc + (countedTarget(s) * activeLinesCount(s)), 0);
  }

  /* ---------------- KPI LOGIC ---------------- */
  function updateAllKPIs(json, activeShift) {
    const allSlots = json.slots || [];
    const ultimo = json.ultimo_slot || null;
    const anyLaunchDay = allSlots.some(s => hasAnyLaunchInSlot(s));

    const globalConsidered = calcUpToUltimo(allSlots, ultimo);
    const globalTotalTarget = targetTotalWeighted(globalConsidered);

    const globalProd = {
      line1: sumLineIfActive(globalConsidered, 1),
      line2: sumLineIfActive(globalConsidered, 2),
      line3: sumLineIfActive(globalConsidered, 3),
      line4: sumLineIfActive(globalConsidered, 4)
    };
    const globalTotalProd = sumTotalActive(globalConsidered);

    const globalTargets = {
      line1: targetForLine(globalConsidered, 1),
      line2: targetForLine(globalConsidered, 2),
      line3: targetForLine(globalConsidered, 3),
      line4: targetForLine(globalConsidered, 4)
    };

    const lastSlot = ultimo ? allSlots.find(s => s.id_slot === ultimo.id_slot) : null;

    // GLOBAL TOTAL CARD
    const elTotalProd = document.getElementById("totalProd");
    const elTotalTarget = document.getElementById("totalTarget");
    if (!anyLaunchDay || globalTotalTarget <= 0) {
      elTotalProd.textContent = "-";
      elTotalTarget.textContent = "Tgt: -";
      updateCardUI("cardTotal", "faceTotal", "pctTotal", null, null);
    } else {
      elTotalProd.textContent = globalTotalProd;
      elTotalTarget.textContent = "Tgt: " + globalTotalTarget;
      const p = globalTotalProd / globalTotalTarget;
      updateCardUI("cardTotal", "faceTotal", "pctTotal", perfStatus(p), p*100);
    }

    // GLOBAL LINE CARDS
    const globalLines = [
      { key:"line1", idx:1, lastId:"lastL1", accId:"accL1", card:"cardLine1", face:"faceL1", pct:"pctL1" },
      { key:"line2", idx:2, lastId:"lastL2", accId:"accL2", card:"cardLine2", face:"faceL2", pct:"pctL2" },
      { key:"line3", idx:3, lastId:"lastL3", accId:"accL3", card:"cardLine3", face:"faceL3", pct:"pctL3" },
      { key:"line4", idx:4, lastId:"lastL4", accId:"accL4", card:"cardLine4", face:"faceL4", pct:"pctL4" }
    ];

    globalLines.forEach(m => {
      const lastVal = lastSlot ? Number(lastSlot[m.key] || 0) : 0;
      const lastTgt = lastSlot ? Number(lastSlot.target_effective || lastSlot.target || 0) : 0;

      document.getElementById(m.lastId).textContent = lastSlot ? `${lastVal}/${lastTgt}` : "-";
      document.getElementById(m.accId).textContent = anyLaunchDay ? `${globalProd[m.key]}/${globalTargets[m.key]}` : "-";

      const tgt = globalTargets[m.key];
      if (!anyLaunchDay || tgt <= 0) {
        updateCardUI(m.card, m.face, m.pct, null, null);
      } else {
        const p = globalProd[m.key] / tgt;
        updateCardUI(m.card, m.face, m.pct, perfStatus(p), p*100);
      }
    });

    // SHIFT
    const shiftSlotsAll = allSlots.filter(s => Number(s.shift) === activeShift);
    const shiftConsidered = calcUpToUltimo(shiftSlotsAll, ultimo);
    const anyLaunchShift = shiftConsidered.some(s => hasAnyLaunchInSlot(s));

    const shiftTotalTarget = targetTotalWeighted(shiftConsidered);
    const shiftProd = {
      line1: sumLineIfActive(shiftConsidered, 1),
      line2: sumLineIfActive(shiftConsidered, 2),
      line3: sumLineIfActive(shiftConsidered, 3),
      line4: sumLineIfActive(shiftConsidered, 4)
    };
    const shiftTotalProd = sumTotalActive(shiftConsidered);

    const shiftTargets = {
      line1: targetForLine(shiftConsidered, 1),
      line2: targetForLine(shiftConsidered, 2),
      line3: targetForLine(shiftConsidered, 3),
      line4: targetForLine(shiftConsidered, 4)
    };

    // SHIFT TOTAL CARD
    const elShiftTotal = document.getElementById("totalProd_Shift");
    const elShiftTarget = document.getElementById("totalTarget_Shift");

    if (!anyLaunchShift || shiftTotalTarget <= 0) {
      elShiftTotal.textContent = "-";
      elShiftTarget.textContent = "Tgt: -";
      updateCardUI("cardTotal_Shift", "faceTotal_Shift", "pctTotal_Shift", null, null);
    } else {
      elShiftTotal.textContent = shiftTotalProd;
      elShiftTarget.textContent = "Tgt: " + shiftTotalTarget;
      const p = shiftTotalProd / shiftTotalTarget;
      updateCardUI("cardTotal_Shift", "faceTotal_Shift", "pctTotal_Shift", perfStatus(p), p*100);
    }

    // SHIFT LINE CARDS
    const shiftLines = [
      { key:"line1", valId:"valL1_Shift", tgtId:"tgtL1_Shift", card:"cardLine1_Shift", face:"faceL1_Shift", pct:"pctL1_Shift" },
      { key:"line2", valId:"valL2_Shift", tgtId:"tgtL2_Shift", card:"cardLine2_Shift", face:"faceL2_Shift", pct:"pctL2_Shift" },
      { key:"line3", valId:"valL3_Shift", tgtId:"tgtL3_Shift", card:"cardLine3_Shift", face:"faceL3_Shift", pct:"pctL3_Shift" },
      { key:"line4", valId:"valL4_Shift", tgtId:"tgtL4_Shift", card:"cardLine4_Shift", face:"faceL4_Shift", pct:"pctL4_Shift" }
    ];

    shiftLines.forEach(m => {
      document.getElementById(m.tgtId).textContent = shiftTargets[m.key] > 0 ? shiftTargets[m.key] : "-";
      document.getElementById(m.valId).textContent = anyLaunchShift ? shiftProd[m.key] : "-";

      const tgt = shiftTargets[m.key];
      if (!anyLaunchShift || tgt <= 0) {
        updateCardUI(m.card, m.face, m.pct, null, null);
      } else {
        const p = shiftProd[m.key] / tgt;
        updateCardUI(m.card, m.face, m.pct, perfStatus(p), p*100);
      }
    });
  }

  function tdWithPerf(value, targetEff, hasLaunch) {
    const td = document.createElement("td");
    if (!hasLaunch) { td.textContent = ""; return td; }
    if (targetEff > 0) {
      const st = perfStatus(value / targetEff);
      td.classList.add(st.cls);
      td.textContent = value;
    } else {
      td.textContent = String(value ?? "");
    }
    return td;
  }

  function tdSummaryWithPerf(value, targetEff) {
    const td = document.createElement("td");
    if (targetEff <= 0) { td.textContent = (value > 0) ? value : ""; return td; }
    const ratio = value / targetEff;
    const st = perfStatus(ratio);
    td.classList.add(st.cls);
    const pct = Math.round(ratio * 100);
    td.innerHTML = `${value} <span style="font-size:0.9em">(${pct}%)</span>`;
    return td;
  }

  function applyShiftDensity(json){
    const used = [1,2,3].filter(s => (json.slots || []).some(x => Number(x.shift) === s)).length || 1;
    document.body.dataset.shifts = String(used);
  }

  function buildTable(json, activeShift) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    const slots = json.slots || [];
    const ultimo = json.ultimo_slot || null;
    const shifts = [1,2,3].map(s => ({ shift:s, slots: slots.filter(x => Number(x.shift) === s) }));

    shifts.forEach(group => {
      if (group.shift > activeShift) return;
      const isCurrentShift = (group.shift === activeShift);

      if (isCurrentShift) {
        group.slots.forEach(slot => {
          const tr = document.createElement("tr");
          if (ultimo && slot.id_slot === ultimo.id_slot) tr.classList.add("row-current");

          const tdShift = document.createElement("td"); tdShift.textContent = "Shift " + slot.shift; tr.appendChild(tdShift);
          const tdTime = document.createElement("td"); tdTime.textContent = slot.label; tr.appendChild(tdTime);

          const targetEff = Number(slot.target_effective || 0);
          const tdTarget = document.createElement("td"); tdTarget.textContent = targetEff > 0 ? targetEff : ""; tr.appendChild(tdTarget);

          const defs = [
            { idx:1, key:"line1", disp:"disp1", st:"st1" },
            { idx:2, key:"line2", disp:"disp2", st:"st2" },
            { idx:3, key:"line3", disp:"disp3", st:"st3" },
            { idx:4, key:"line4", disp:"disp4", st:"st4" }
          ];

          // L1..L4
          defs.forEach(d => {
            const stKind = slot[d.st] || "RUN";
            if (stKind !== "RUN") {
              const td = document.createElement("td");
              td.textContent = slot[d.disp] || "";
              td.classList.add(statusClass(stKind));
              tr.appendChild(td);
              return;
            }
            if (!hasAnyLaunchInSlot(slot)) {
              const td = document.createElement("td"); td.textContent = ""; tr.appendChild(td); return;
            }
            const raw = slot[d.key];
            const v = (raw === "" || raw === null || raw === undefined) ? 0 : Number(raw);
            tr.appendChild(tdWithPerf(v, targetEff, true));
          });

          // TOTAL (somente linhas ativas + target x linhas ativas)
          if (!hasAnyLaunchInSlot(slot)) {
            const td = document.createElement("td"); td.textContent = ""; tr.appendChild(td);
          } else {
            const sumLines =
              (isThisLineActive(slot, 1) ? Number(slot.line1 || 0) : 0) +
              (isThisLineActive(slot, 2) ? Number(slot.line2 || 0) : 0) +
              (isThisLineActive(slot, 3) ? Number(slot.line3 || 0) : 0) +
              (isThisLineActive(slot, 4) ? Number(slot.line4 || 0) : 0);

            const mult = activeLinesCount(slot);
            const targetTotal = targetEff * mult;
            tr.appendChild(tdWithPerf(sumLines, targetTotal, true));
          }

          tbody.appendChild(tr);
        });
      }

      // SHIFT SUMMARY ROW
      if (group.slots.length > 0) {
        const hasAnyLaunchShift = group.slots.some(s => hasAnyLaunchInSlot(s));

        const sumTargetCounted = group.slots.reduce((a,s)=>a + countedTarget(s), 0);

        const sum = {
          target: sumTargetCounted,
          line1: group.slots.reduce((a,s)=>a + Number(s.line1||0),0),
          line2: group.slots.reduce((a,s)=>a + Number(s.line2||0),0),
          line3: group.slots.reduce((a,s)=>a + Number(s.line3||0),0),
          line4: group.slots.reduce((a,s)=>a + Number(s.line4||0),0)
        };

        // target TOTAL ponderado por slot (countedTarget * linhasAtivas)
        const sumTargetTotalWeighted = group.slots.reduce((a,s)=>{
          return a + (countedTarget(s) * activeLinesCount(s));
        }, 0);

        // TOTAL produzido só das linhas ativas
        const sumTotalActive = group.slots.reduce((acc, s) => {
          return acc +
            (isThisLineActive(s, 1) ? Number(s.line1 || 0) : 0) +
            (isThisLineActive(s, 2) ? Number(s.line2 || 0) : 0) +
            (isThisLineActive(s, 3) ? Number(s.line3 || 0) : 0) +
            (isThisLineActive(s, 4) ? Number(s.line4 || 0) : 0);
        }, 0);

        const trSum = document.createElement("tr");
        trSum.classList.add("shift-sum");

        const td1 = document.createElement("td");
        td1.colSpan = 2;
        td1.innerHTML = `SHIFT ${group.shift} RESULT`;
        trSum.appendChild(td1);

        const tdT = document.createElement("td");
        tdT.textContent = sum.target > 0 ? sum.target : "";
        trSum.appendChild(tdT);

        // L1..L4 com target por linha (sum.target)
        ["line1","line2","line3","line4"].forEach(k => {
          if (!hasAnyLaunchShift || sum.target <= 0) {
            const td = document.createElement("td"); td.textContent = ""; trSum.appendChild(td); return;
          }
          trSum.appendChild(tdSummaryWithPerf(sum[k], sum.target));
        });

        // TOTAL
        if (!hasAnyLaunchShift || sumTargetTotalWeighted <= 0) {
          const td = document.createElement("td"); td.textContent = ""; trSum.appendChild(td);
        } else {
          trSum.appendChild(tdSummaryWithPerf(sumTotalActive, sumTargetTotalWeighted));
        }

        tbody.appendChild(trSum);
      }
    });
  }

  async function refreshDashboard() {
    try {
      const today = getTodayISO();
      const res = await fetch(`${SCRIPT_URL}?action=dailyProduction&data=${today}`);
      const json = await res.json();
      if (json.status !== "success") return;

      let activeShift = 1;
      if (json.ultimo_slot) activeShift = Number(json.ultimo_slot.shift);

      applyShiftDensity(json);
      buildTable(json, activeShift);
      updateAllKPIs(json, activeShift);
    } catch (err) {
      console.error(err);
    }
  }

  startDateTime();
  refreshDashboard();
  setInterval(refreshDashboard, 30000);
</script>
</body>
</html>

