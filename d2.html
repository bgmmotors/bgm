<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>PERFORMANCE CLM6 - ANDON FINAL</title>
  <style>
    html, body { 
      margin: 0; padding: 0; 
      height: 100vh; width: 100vw;
      background: #000; 
      font-family: Arial, Helvetica, sans-serif; 
      color: #fff; 
      overflow: hidden; 
    }

    /* --- GRID SYSTEM MATEMÁTICO --- */
    /* Define a largura exata de cada coluna para ser usada em Cards e Tabela */
    :root {
      /* Shift(6%) Time(12%) Target(7%) L1(15%) L2(15%) L3(15%) L4(15%) Total(Resto) */
      --grid-layout: 6% 12% 7% 15% 15% 15% 15% 1fr;
    }

    .wrapper { 
      display: flex; flex-direction: column; 
      height: 100%; padding: 10px 14px; box-sizing: border-box; 
    }

    /* HEADER */
    .header { 
      flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; 
      margin-bottom: 6px; height: 40px;
    }
    .logo { height: 34px; width: auto; display: block; }
    .header-title { font-size: 32px; font-weight: 900; letter-spacing: 1px; }
    .header-date { font-size: 22px; font-weight: 900; color: #ddd; }

    /* --- ESTRUTURA DE LINHAS (KPIs e TABELA) --- */
    /* Essa classe garante que o cabeçalho dos cards e as linhas da tabela sigam o mesmo grid */
    .master-grid {
      display: grid;
      grid-template-columns: var(--grid-layout);
      gap: 0; /* Gap zero para alinhamento perfeito */
      align-items: center;
    }

    /* KPI ROW (TOPO E RODAPÉ) */
    .kpi-row {
      flex: 0 0 auto;
      margin-bottom: 4px;
      /* Padding right compensa scroll da tabela se necessário, ajustável */
      padding-right: 6px; 
    }

    /* Células Invisíveis (Spacer) */
    .kpi-spacer {
      display: flex; align-items: flex-end; padding-right: 10px; height: 100%;
    }
    .section-label {
      font-size: 13px; font-weight: 900; color: #00b050; 
      text-transform: uppercase; border-bottom: 2px solid #00b050; 
      width: 100%; margin-bottom: 5px;
    }
    .section-label-btm {
      font-size: 13px; font-weight: 900; color: #777; 
      text-transform: uppercase; margin-bottom: 5px; width: 100%;
    }

    /* Células de Cards */
    .kpi-cell {
      padding: 0 4px; /* Espaço entre cards */
      height: 90px;
      box-sizing: border-box;
    }

    .kpi-card {
      background: #111;
      border-radius: 10px;
      padding: 6px 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.6);
      border: 2px solid #444; 
      height: 100%; 
      display: flex; flex-direction: column; justify-content: center;
    }

    .card-grid { 
      display: grid; grid-template-columns: 1fr auto; 
      gap: 4px; align-items: center; height: 100%;
    }

    .kpi-title { font-size: 13px; margin-bottom: 2px; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .kpi-main { font-size: 26px; font-weight: 900; line-height: 1; color:#fff; }
    .kpi-sub  { font-size: 11px; color: #999; }
    .metric { margin-top: 3px; }
    .metric-label { font-size: 10px; color: #999; }
    .metric-value { font-size: 14px; font-weight: 900; color: #fff; }

    .right-col { display: flex; flex-direction: column; align-items: center; width: 45px; }
    .big-face svg { width: 36px; height: 36px; display: block; }
    .face-pct { font-size: 15px; font-weight: 900; color: #fff; margin-top: 2px; }

    /* TABELA */
    .table-container { 
      flex: 1 1 auto; 
      background: #111; 
      border-radius: 8px; 
      border: 1px solid #333;
      overflow-y: auto; 
      display: flex; flex-direction: column;
    }
    
    /* Cabeçalho da Tabela */
    .table-head {
      position: sticky; top: 0; z-index: 10;
      background: #222; 
      border-bottom: 2px solid #555;
      font-size: 13px; font-weight: bold;
    }
    .th-cell {
      padding: 8px 4px;
      border-right: 1px solid #555;
      text-align: center;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .th-cell:last-child { border-right: none; background: #1a1a1a; }

    /* Corpo da Tabela */
    .table-row {
      border-bottom: 1px solid #222;
      font-size: 14px;
    }
    .row-current { background: #262626; }

    .td-cell {
      padding: 6px 4px;
      border-right: 1px solid #222;
      text-align: center;
      height: 30px; 
      display: flex; align-items: center; justify-content: center; /* Centraliza vertical e horizontal */
      white-space: nowrap; overflow: hidden;
    }
    .td-cell:last-child { border-right: none; }

    /* Cores */
    .cell-ok  { background: #00b050; color: #000; font-weight: 900; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
    .cell-mid { background: #FFFF00; color: #000; font-weight: 900; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
    .cell-nok { background: #c00000; color: #fff; font-weight: 900; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
    
    .cell-mnt, .cell-mat, .cell-peo, .cell-qual, .cell-nosched { 
      font-weight: 900; font-size: 11px; color:#000; width:100%; height:100%; display:flex; align-items:center; justify-content:center;
    }
    .cell-mnt { background: orange; }
    .cell-mat { background: #808080; }
    .cell-peo { background: #ff69b4; }
    .cell-qual{ background: #ffd400; }
    .cell-nosched { background: #0070c0; color:#fff; }

    /* Shift Summary */
    .shift-sum { border-top: 3px solid #fff; border-bottom: 3px solid #fff; }
    .shift-sum .td-cell {
      background: #003366; color: #fff; font-weight: 900; font-size: 15px;
      height: 40px;
    }
    /* Summary Spans */
    .span-2 { grid-column: span 2; } /* Ocupa Shift + Time */

    .face-stroke { stroke: currentColor; stroke-width: 3; fill: none; stroke-linecap: round; stroke-linejoin: round; }

    .footer-divider { border-top: 1px solid #444; padding-top: 8px; margin-top: auto;}

    /* Responsividade Texto */
    body[data-shifts="1"] .table-row { font-size: 15px; }
  </style>
</head>
<body>

<div class="wrapper">

  <div class="header">
    <div class="header-left"><img class="logo" src="assets/BGM.png" alt="BGM"></div>
    <div class="header-center"><div class="header-title">PERFORMANCE CLM6</div></div>
    <div class="header-right"><div class="header-date" id="dateTime">--</div></div>
  </div>

  <div class="master-grid kpi-row">
    <div style="grid-column: span 3; padding-right:10px;">
      <div class="kpi-spacer">
        <div class="section-label">CURRENT SHIFT</div>
      </div>
    </div>

    <div class="kpi-cell">
      <div class="kpi-card" id="cardLine1_Shift">
        <div class="card-grid">
          <div>
            <div class="kpi-title">Line 1</div>
            <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="valL1_Shift">-</div></div>
            <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL1_Shift">-</div></div>
          </div>
          <div class="right-col"><div class="big-face" id="faceL1_Shift"></div><div class="face-pct" id="pctL1_Shift"></div></div>
        </div>
      </div>
    </div>
    <div class="kpi-cell">
      <div class="kpi-card" id="cardLine2_Shift">
        <div class="card-grid">
          <div>
            <div class="kpi-title">Line 2</div>
            <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="valL2_Shift">-</div></div>
            <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL2_Shift">-</div></div>
          </div>
          <div class="right-col"><div class="big-face" id="faceL2_Shift"></div><div class="face-pct" id="pctL2_Shift"></div></div>
        </div>
      </div>
    </div>
    <div class="kpi-cell">
      <div class="kpi-card" id="cardLine3_Shift">
        <div class="card-grid">
          <div>
            <div class="kpi-title">Line 3</div>
            <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="valL3_Shift">-</div></div>
            <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL3_Shift">-</div></div>
          </div>
          <div class="right-col"><div class="big-face" id="faceL3_Shift"></div><div class="face-pct" id="pctL3_Shift"></div></div>
        </div>
      </div>
    </div>
    <div class="kpi-cell">
      <div class="kpi-card" id="cardLine4_Shift">
        <div class="card-grid">
          <div>
            <div class="kpi-title">Line 4</div>
            <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="valL4_Shift">-</div></div>
            <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL4_Shift">-</div></div>
          </div>
          <div class="right-col"><div class="big-face" id="faceL4_Shift"></div><div class="face-pct" id="pctL4_Shift"></div></div>
        </div>
      </div>
    </div>
    <div class="kpi-cell">
      <div class="kpi-card" id="cardTotal_Shift">
        <div class="card-grid">
          <div>
            <div class="kpi-title">Shift Total</div>
            <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="totalProd_Shift">-</div></div>
            <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="totalTarget_Shift">-</div></div>
          </div>
          <div class="right-col"><div class="big-face" id="faceTotal_Shift"></div><div class="face-pct" id="pctTotal_Shift"></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-container">
    <div class="master-grid table-head">
      <div class="th-cell">Shift</div>
      <div class="th-cell">Time</div>
      <div class="th-cell">Target</div>
      <div class="th-cell">Line 1</div>
      <div class="th-cell">Line 2</div>
      <div class="th-cell">Line 3</div>
      <div class="th-cell">Line 4</div>
      <div class="th-cell">TOTAL</div>
    </div>
    <div id="tableBody"></div>
  </div>

  <div class="footer-divider">
    <div class="master-grid kpi-row">
      <div style="grid-column: span 3; padding-right:10px;">
        <div class="kpi-spacer">
          <div class="section-label-btm">GLOBAL (ACCUMULATED)</div>
        </div>
      </div>

      <div class="kpi-cell">
        <div class="kpi-card" id="cardLine1">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Line 1 Global</div>
              <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="accL1">-</div></div>
              <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL1_Glb">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL1"></div><div class="face-pct" id="pctL1"></div></div>
          </div>
        </div>
      </div>
      <div class="kpi-cell">
        <div class="kpi-card" id="cardLine2">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Line 2 Global</div>
              <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="accL2">-</div></div>
              <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL2_Glb">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL2"></div><div class="face-pct" id="pctL2"></div></div>
          </div>
        </div>
      </div>
      <div class="kpi-cell">
        <div class="kpi-card" id="cardLine3">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Line 3 Global</div>
              <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="accL3">-</div></div>
              <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL3_Glb">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL3"></div><div class="face-pct" id="pctL3"></div></div>
          </div>
        </div>
      </div>
      <div class="kpi-cell">
        <div class="kpi-card" id="cardLine4">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Line 4 Global</div>
              <div class="metric"><div class="metric-label">Acc</div><div class="metric-value" id="accL4">-</div></div>
              <div class="metric"><div class="metric-label">Tgt</div><div class="metric-value" id="tgtL4_Glb">-</div></div>
            </div>
            <div class="right-col"><div class="big-face" id="faceL4"></div><div class="face-pct" id="pctL4"></div></div>
          </div>
        </div>
      </div>
      <div class="kpi-cell">
        <div class="kpi-card" id="cardTotal">
          <div class="card-grid">
            <div>
              <div class="kpi-title">Total Global</div>
              <div class="kpi-main" id="totalProd">-</div>
              <div class="kpi-sub" id="totalTarget">Tgt: -</div>
            </div>
            <div class="right-col"><div class="big-face" id="faceTotal"></div><div class="face-pct" id="pctTotal"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxugNG9AE1dpoobCrOYFaTzbH3EUVkd1SbbASSdcaG3eZBLuoePB5F0bolIgiCiqqIT/exec";

  function getTodayISO() {
    const d = new Date();
    // Regra das 06:00
    if (d.getHours() < 6) d.setDate(d.getDate() - 1);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function startDateTime() {
    const el = document.getElementById("dateTime");
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    function tick() {
      const now = new Date();
      const d = String(now.getDate()).padStart(2, "0");
      const m = monthNames[now.getMonth()];
      const y = String(now.getFullYear()).slice(-2);
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      el.textContent = `${d}-${m}-${y}  ${hh}:${mm}`;
    }
    tick(); setInterval(tick, 1000);
  }

  function faceSVG(type) {
    const common = `class="face-stroke"`;
    const head = `<circle cx="32" cy="32" r="22" ${common}></circle>`;
    const eyes = `<circle cx="24" cy="28" r="2" ${common}></circle><circle cx="40" cy="28" r="2" ${common}></circle>`;
    let mouth = "";
    if (type === "happy") mouth = `<path d="M22 38 Q32 46 42 38" ${common}></path>`;
    else if (type === "neutral") mouth = `<path d="M22 40 L42 40" ${common}></path>`;
    else mouth = `<path d="M22 44 Q32 36 42 44" ${common}></path>`;
    return `<svg viewBox="0 0 64 64" aria-hidden="true">${head}${eyes}${mouth}</svg>`;
  }

  function perfStatus(pct) {
    if (pct >= 1) return { status:"OK", cls:"cell-ok", face:"happy" };
    if (pct >= 0.95) return { status:"MID", cls:"cell-mid", face:"neutral" };
    return { status:"NOK", cls:"cell-nok", face:"sad" };
  }

  function statusClass(kind) {
    if (kind === "STOP_MAINT") return "cell-mnt";
    if (kind === "STOP_MAT") return "cell-mat";
    if (kind === "STOP_PEO") return "cell-peo";
    if (kind === "STOP_QUAL") return "cell-qual";
    if (kind === "NO_SCHEDULE") return "cell-nosched";
    return "";
  }

  function isNoSchedule(val) {
    if (!val) return false;
    const s = String(val).trim();
    // Verifica códigos fornecidos pelo usuário
    return (s === ".5" || s === "5." || s === ",5" || s === "5,");
  }

  function updateCardUI(cardId, faceId, pctId, statusObj, percentage) {
    const card = document.getElementById(cardId);
    const face = document.getElementById(faceId);
    const pct  = document.getElementById(pctId);
    if(!card || !face || !pct) return;

    if (!statusObj) {
      card.style.borderColor = "#444";
      face.innerHTML = "";
      pct.textContent = "";
      return;
    }
    if (statusObj.status === "OK") card.style.borderColor = "#00b050";
    else if (statusObj.status === "MID") card.style.borderColor = "#FFFF00";
    else card.style.borderColor = "#c00000";

    face.style.color = (statusObj.status === "NOK") ? "#c00000" : (statusObj.status === "MID" ? "#FFFF00" : "#00b050");
    face.innerHTML = faceSVG(statusObj.face);
    pct.textContent = Math.round(percentage) + "%";
  }

  function hasAnyLaunchInSlot(slot) { return slot && slot.has_launch === true; }
  
  function getLineTarget(slot, stKey) {
    const st = slot[stKey];
    if (isNoSchedule(st)) return 0;
    return Number(slot.target_effective || slot.target || 0);
  }

  function calcUpToUltimo(slots, ultimo) {
    if (!ultimo) return slots; 
    const out = [];
    for (const s of slots) {
      out.push(s);
      if (s.id_slot === ultimo.id_slot) break;
    }
    return out;
  }

  function updateAllKPIs(json, activeShift) {
    const allSlots = json.slots || [];
    const ultimo = json.ultimo_slot || null;
    const anyLaunchDay = allSlots.some(s => hasAnyLaunchInSlot(s));

    // --- GLOBAL ---
    const globalConsidered = calcUpToUltimo(allSlots, ultimo);
    let gProd = { l1:0, l2:0, l3:0, l4:0 };
    let gTgt  = { l1:0, l2:0, l3:0, l4:0 };

    globalConsidered.forEach(s => {
      gProd.l1 += Number(s.line1||0);
      gProd.l2 += Number(s.line2||0);
      gProd.l3 += Number(s.line3||0);
      gProd.l4 += Number(s.line4||0);

      gTgt.l1 += getLineTarget(s, "st1");
      gTgt.l2 += getLineTarget(s, "st2");
      gTgt.l3 += getLineTarget(s, "st3");
      gTgt.l4 += getLineTarget(s, "st4");
    });

    const gTotalProd = gProd.l1 + gProd.l2 + gProd.l3 + gProd.l4;
    const gTotalTgt  = gTgt.l1 + gTgt.l2 + gTgt.l3 + gTgt.l4;

    const globalLines = [
      { key:"l1", valId:"accL1", tgtId:"tgtL1_Glb", card:"cardLine1", face:"faceL1", pct:"pctL1" },
      { key:"l2", valId:"accL2", tgtId:"tgtL2_Glb", card:"cardLine2", face:"faceL2", pct:"pctL2" },
      { key:"l3", valId:"accL3", tgtId:"tgtL3_Glb", card:"cardLine3", face:"faceL3", pct:"pctL3" },
      { key:"l4", valId:"accL4", tgtId:"tgtL4_Glb", card:"cardLine4", face:"faceL4", pct:"pctL4" }
    ];

    globalLines.forEach(m => {
      const t = gTgt[m.key];
      const v = gProd[m.key];
      document.getElementById(m.valId).textContent = anyLaunchDay ? v : "-";
      document.getElementById(m.tgtId).textContent = anyLaunchDay ? t : "-";
      if (!anyLaunchDay || t <= 0) updateCardUI(m.card, m.face, m.pct, null, null);
      else {
        const p = v / t;
        updateCardUI(m.card, m.face, m.pct, perfStatus(p), p*100);
      }
    });

    document.getElementById("totalProd").textContent = anyLaunchDay ? gTotalProd : "-";
    document.getElementById("totalTarget").textContent = "Tgt: " + (anyLaunchDay ? gTotalTgt : "-");
    if (!anyLaunchDay || gTotalTgt <= 0) updateCardUI("cardTotal", "faceTotal", "pctTotal", null, null);
    else {
      const p = gTotalProd / gTotalTgt;
      updateCardUI("cardTotal", "faceTotal", "pctTotal", perfStatus(p), p*100);
    }

    // --- SHIFT ---
    const shiftSlotsAll = allSlots.filter(s => Number(s.shift) === activeShift);
    const shiftConsidered = calcUpToUltimo(shiftSlotsAll, ultimo);
    const anyLaunchShift = shiftConsidered.some(s => hasAnyLaunchInSlot(s));

    let sProd = { l1:0, l2:0, l3:0, l4:0 };
    let sTgt  = { l1:0, l2:0, l3:0, l4:0 };

    shiftConsidered.forEach(s => {
      sProd.l1 += Number(s.line1||0);
      sProd.l2 += Number(s.line2||0);
      sProd.l3 += Number(s.line3||0);
      sProd.l4 += Number(s.line4||0);

      sTgt.l1 += getLineTarget(s, "st1");
      sTgt.l2 += getLineTarget(s, "st2");
      sTgt.l3 += getLineTarget(s, "st3");
      sTgt.l4 += getLineTarget(s, "st4");
    });

    const sTotalProd = sProd.l1 + sProd.l2 + sProd.l3 + sProd.l4;
    const sTotalTgt  = sTgt.l1 + sTgt.l2 + sTgt.l3 + sTgt.l4;

    const shiftLines = [
      { key:"l1", valId:"valL1_Shift", tgtId:"tgtL1_Shift", card:"cardLine1_Shift", face:"faceL1_Shift", pct:"pctL1_Shift" },
      { key:"l2", valId:"valL2_Shift", tgtId:"tgtL2_Shift", card:"cardLine2_Shift", face:"faceL2_Shift", pct:"pctL2_Shift" },
      { key:"l3", valId:"valL3_Shift", tgtId:"tgtL3_Shift", card:"cardLine3_Shift", face:"faceL3_Shift", pct:"pctL3_Shift" },
      { key:"l4", valId:"valL4_Shift", tgtId:"tgtL4_Shift", card:"cardLine4_Shift", face:"faceL4_Shift", pct:"pctL4_Shift" }
    ];

    shiftLines.forEach(m => {
      const t = sTgt[m.key];
      const v = sProd[m.key];
      document.getElementById(m.tgtId).textContent = anyLaunchShift ? t : "-";
      document.getElementById(m.valId).textContent = anyLaunchShift ? v : "-";
      if (!anyLaunchShift || t <= 0) updateCardUI(m.card, m.face, m.pct, null, null);
      else {
        const p = v / t;
        updateCardUI(m.card, m.face, m.pct, perfStatus(p), p*100);
      }
    });

    document.getElementById("totalProd_Shift").textContent = anyLaunchShift ? sTotalProd : "-";
    document.getElementById("totalTarget_Shift").textContent = "Tgt: " + (anyLaunchShift ? sTotalTgt : "-");
    
    if (!anyLaunchShift || sTotalTgt <= 0) updateCardUI("cardTotal_Shift", "faceTotal_Shift", "pctTotal_Shift", null, null);
    else {
      const p = sTotalProd / sTotalTgt;
      updateCardUI("cardTotal_Shift", "faceTotal_Shift", "pctTotal_Shift", perfStatus(p), p*100);
    }
  }

  function divWithPerf(value, targetEff, hasLaunch) {
    const div = document.createElement("div");
    div.className = "td-cell";
    if (!hasLaunch || targetEff <= 0) { 
      div.textContent = (value > 0 || hasLaunch) ? value : ""; 
      return div; 
    }
    const st = perfStatus(value / targetEff);
    div.innerHTML = `<div class="${st.cls}">${value}</div>`;
    return div;
  }

  function divSummaryWithPerf(value, targetEff) {
    const div = document.createElement("div");
    div.className = "td-cell";
    if (targetEff <= 0) { 
        // Se target é zero, mas tem produção, não mostra erro
        div.textContent = (value > 0) ? value : ""; 
        return div; 
    }
    const ratio = value / targetEff;
    const st = perfStatus(ratio);
    
    // Ajuste visual para ficar igual ao seu print (barra cheia)
    // As classes .cell-ok já possuem width:100%
    div.innerHTML = `<div class="${st.cls}">${value} <span style="font-size:0.8em; margin-left:4px;">(${Math.round(ratio*100)}%)</span></div>`;
    return div;
  }

  function simpleDiv(text, cls) {
    const d = document.createElement("div");
    d.className = "td-cell";
    if(cls) {
        d.innerHTML = `<div class="${cls}">${text}</div>`;
    } else {
        d.textContent = text;
    }
    return d;
  }

  function applyShiftDensity(json){
    const used = [1,2,3].filter(s => (json.slots || []).some(x => Number(x.shift) === s)).length || 1;
    document.body.dataset.shifts = String(used);
  }

  function buildTable(json, activeShift) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    const slots = json.slots || [];
    const ultimo = json.ultimo_slot || null;
    const shifts = [1,2,3].map(s => ({ shift:s, slots: slots.filter(x => Number(x.shift) === s) }));

    shifts.forEach(group => {
      if (group.shift > activeShift) return; 
      const isCurrentShift = (group.shift === activeShift);

      if (isCurrentShift) {
        group.slots.forEach(slot => {
          const row = document.createElement("div");
          row.className = "master-grid table-row";
          if (ultimo && slot.id_slot === ultimo.id_slot) row.classList.add("row-current");
          
          row.appendChild(simpleDiv("Shift " + slot.shift));
          row.appendChild(simpleDiv(slot.label));
          
          const targetSlot = Number(slot.target_effective || 0);
          row.appendChild(simpleDiv(targetSlot > 0 ? targetSlot : ""));

          // Lines
          let rowProd = 0;
          let rowTgt = 0;
          const defs = [
            { key:"line1", disp:"disp1", st:"st1" },
            { key:"line2", disp:"disp2", st:"st2" },
            { key:"line3", disp:"disp3", st:"st3" },
            { key:"line4", disp:"disp4", st:"st4" }
          ];

          defs.forEach(d => {
            const stKind = slot[d.st] || "RUN";
            const isStop = (stKind !== "RUN");
            
            // Só soma target se a linha não estiver parada
            const lineTgt = isNoSchedule(stKind) ? 0 : targetSlot;
            rowTgt += lineTgt;

            if (isStop) {
              row.appendChild(simpleDiv(slot[d.disp] || "", statusClass(stKind)));
              return;
            }
            if (!hasAnyLaunchInSlot(slot)) {
              row.appendChild(simpleDiv("")); return;
            }
            
            const raw = slot[d.key];
            const v = (raw === "" || raw === null || raw === undefined) ? 0 : Number(raw);
            rowProd += v;
            row.appendChild(divWithPerf(v, lineTgt, true));
          });

          // TOTAL COLUMN
          if (hasAnyLaunchInSlot(slot)) {
            row.appendChild(divWithPerf(rowProd, rowTgt, true));
          } else {
            row.appendChild(simpleDiv(""));
          }
          tbody.appendChild(row);
        });
      }

      if (group.slots.length > 0) {
        let sumProd = { l1:0, l2:0, l3:0, l4:0 };
        let sumTgt = { l1:0, l2:0, l3:0, l4:0 };
        let totalSlotTarget = 0; // Soma dos targets das linhas (apenas visual, sem lógica de eficiência)
        let hasData = false;

        group.slots.forEach(s => {
          if (hasAnyLaunchInSlot(s)) {
              hasData = true;
              // SÓ SOMA O TARGET NA BARRA AZUL SE O SLOT TIVER DADOS
              totalSlotTarget += Number(s.target_effective || 0);
              
              sumTgt.l1 += getLineTarget(s, "st1");
              sumTgt.l2 += getLineTarget(s, "st2");
              sumTgt.l3 += getLineTarget(s, "st3");
              sumTgt.l4 += getLineTarget(s, "st4");
          }

          sumProd.l1 += Number(s.line1||0);
          sumProd.l2 += Number(s.line2||0);
          sumProd.l3 += Number(s.line3||0);
          sumProd.l4 += Number(s.line4||0);
        });

        const sumTotalProd = sumProd.l1 + sumProd.l2 + sumProd.l3 + sumProd.l4;
        const sumTotalTgt = sumTgt.l1 + sumTgt.l2 + sumTgt.l3 + sumTgt.l4;

        const rowSum = document.createElement("div"); 
        rowSum.className = "master-grid shift-sum";
        
        // Label ocupa 2 colunas
        const d1 = document.createElement("div");
        d1.className = "td-cell"; 
        d1.style.gridColumn = "span 2"; 
        d1.textContent = `SHIFT ${group.shift} RESULT`; 
        rowSum.appendChild(d1);
        
        // Target Sum (Corrigido para só mostrar slots realizados)
        rowSum.appendChild(simpleDiv(totalSlotTarget > 0 ? totalSlotTarget : ""));

        ["l1","l2","l3","l4"].forEach(k => {
          if (!hasData || sumTgt[k] <= 0) rowSum.appendChild(simpleDiv(""));
          else rowSum.appendChild(divSummaryWithPerf(sumProd[k], sumTgt[k]));
        });

        // Total Column Summary
        if (!hasData || sumTotalTgt <= 0) rowSum.appendChild(simpleDiv(""));
        else rowSum.appendChild(divSummaryWithPerf(sumTotalProd, sumTotalTgt));

        tbody.appendChild(rowSum);
      }
    });
  }

  async function refreshDashboard() {
    try {
      const today = getTodayISO();
      // Se quiser forçar data para teste:
      // const today = "2025-11-21";
      const res = await fetch(`${SCRIPT_URL}?action=dailyProduction&data=${today}`);
      const json = await res.json();
      if (json.status !== "success") return;
      
      let activeShift = 1;
      if (json.ultimo_slot) activeShift = Number(json.ultimo_slot.shift);

      applyShiftDensity(json);
      buildTable(json, activeShift);
      updateAllKPIs(json, activeShift);
    } catch (err) { console.error(err); }
  }

  startDateTime();
  refreshDashboard();
  setInterval(refreshDashboard, 30000);
</script>
</body>
</html>
